\chapter{CW-NIR laser as an effective neuromodulation technique}
\section{Introduction}

Effective  stimulation is an essential tool to study brain dynamics. Many techniques have risen since the first use of  electrical, chemical and mechanical stimulation, e.g., see Refs.~\citenum{Cogan2008, Chamorro2012, carter2015guide, Bickle16}. Optical methods are widely spread, as they allow visualization \cite{Lecoq9042} and stimulation in a less invasive manner. One example is optogenetics \cite{Boyden2005, Yizhar2011, Tye2012,bansal2022towards}, which is effective in modifying neural activity with high spatio-temporal resolution. Another example of non-invasive stimulation is Transcranial Magnetic Stimulation \cite{Valero2017transcranial}, which is succeeding in clinical applications. However, they both present limitations such as the need to genetically modify the living system or restricted spatial precision, respectively. In this context, infrared laser is an optical technique that has risen in popularity in the last decade. From its first applications \cite{Wells2005, Izzo2007}, studies have shown its ability for modulating action potentials in different systems \cite{Liang2009, Goyal2012, Brown2020, Barrett2018, Shapiro2012, Cayce2014, Begeng2022}. Beyond its aspect as a research stimulation technique, it has also been tested for clinical use, e.g., in Parkinson's disease, reversing brain age-related effects or depression treatment \cite{Konstantinovic2013, DISNER2016780, Wang2017, Saucedo2021, Pan2023}. The wide range of possibilities for non-invasive neuromodulation with high temporal and spatial precision makes this neural stimulation method so attractive. 
 
The identification of the biophysical source of infrared neuromodulation has strong implications for applications in multiple contexts but it is still under discussion. It is difficult to associate this process to a single specific cause, since neural systems have distinct components reactive to the irradiation. However, most of the results point to a photo-thermal effect. The excitation driven by the laser stimulation might be caused by temperature gradient \cite{Wells2007}. In addition, different candidates for the change in neural activity have been suggested, such as capacitance \cite{Shapiro2012, Plaksin2018}, specific modulation of channels sensitive to temperature as TRPV4 \cite{Albert2012}, acceleration of ionic channels \cite{Liang2009}, or altering the $Ca^{2+}$ cycle possibly mediated by modulation of mitochondrial activity \cite{Dittami2011, Lumbreras2014, Saucedo2021}.

Distinct types of infrared laser and action modes, in terms of the power, duration, frequency of stimulation and wavelength have been used in previous studies, see Refs.~\citenum{Izzo2007, Wells2005,Ping23}. The effect is highly dependent on the stimulation configuration. Most works have focused on pulsed lasers to induce spiking activity due to their stronger temperature gradient production. However, some clinical studies have successfully applied continuous-wave (CW) laser for brain stimulation \cite{Saucedo2021}.

The use of closed-loop techniques has a large potential in neuroscience, for both physiological and clinical research studies \cite{potter2010, Chamorro2012, couto_firing_2015,Lareo2016,Varona2016a,zrenner2016closed,Reyes-Sanchez2020,REYESSANCHEZ2023}, since they allow adjusting the stimulation to the context of the ongoing neural dynamics and specific system/subject. Some of these tools have been developed in open-source, including optical techniques, e.g.  Refs. \citenum{siegle_neural_2015,dagnew_cerebralux_2017,Amaducci2019,stih_stytra_2019,robbins_optogenie_2021}, improving the accessibility, reproducibility and standardization of the studies and methods. However, near-infrared (NIR) lasers have been used with fixed/periodic stimulus but, to the best of our knowledge, they have not been exploited in activity-dependent protocols. 
%The validation of closed-loop open-source approaches of NIR laser stimulation can result in a wide variety of effective applications.

Here we explore the effect of CW-NIR laser on the dynamics of individual neurons. We employ a laser with constant optical power density on the sample in two modalities: sustained and activity-dependent stimulation. In the first case, the laser stimulation is sustained --the duration of the illumination is constant for more than 1 minute--, and in the second case it is driven in an activity-dependent manner implemented by the open-source Linux software RTXI\cite{Patel2017} --the onset of the stimulation is determined by ongoing neural events and delivered transiently through software control--.
We studied the effect CW-NIR illumination focused on neurons with spontaneous tonic firing. Combining experimental results with modeling analysis allowed exploring the candidates that can explain the observed neuromodulation. We present a novel procedure for NIR laser stimulation to dissect and intervene in the waveform dynamics through activity-dependent stimulation. By interlacing results from theoretical simulations and sustained and activity-dependent stimulation, we identify the dynamical elements behind action potential dynamics under CW-NIR modulation. We discard any single candidate of the biophysical effect, but rather we show that laser illumination affects multiple membrane factors simultaneously.

% Sobran 1 palabras

% The use of closed-loop techniques has a large potential in neuroscience, for both physiological and clinical research studies \cite{potter2010, Chamorro2012, couto_firing_2015,Lareo2016,Varona2016a,zrenner2016closed,Reyes-Sanchez2020,Amaducci2019,REYESSANCHEZ2023}, since they allow adjusting the stimulation to the context of the ongoing neural dynamics and specific system/subject. Near-infrared (NIR) lasers have only been used with fixed/periodic stimulus but not in activity-dependent protocols. However, the validation of closed-loop approaches of NIR laser stimulation can result in a wide variety of effective applications. 
% %
\section{Materials and methods}

\subsection{Intracellular recordings}
\label{Lymnaea stagnalis preparation}
The experimental data was obtained using intracellular electrophysiological recordings with sharp electrodes in the neurons of \textit{Lymnaea stagnalis}. This animal model was used because of the easy accessibility of the neurons that are distributed and organized in different ganglia, with a distinct function associated to each one of them. For the experiments, we chose the right parietal ganglion since it is one of the largest ganglia in the system and so are its neurons. In addition, many neurons in this ganglion are usually spontaneously active and present a tonic spiking that can last for hours. It is also convenient of this animal that its neural activity is slow, which allows us to explore the modulation of the action potential dynamics at multiple time scales with larger resolution in the electrophysiological recordings. Membrane potential was recorded using 3 M $KCl$ filled electrodes and a DC amplifier (ELC-03M, NPI Electronic, Hauptstrasse, Tamm, Germany). Recordings were acquired at 10 KHz using an A/D board (PCI-625 with a BNC-2090A DAQ device, National Instruments). 

\subsection{\textit{Lymnaea stagnalis} preparation}

The neural system was isolated from the rest of the body to perform the electrophysiological recordings. The body shell was removed, along with other visceral parts above the neural system. Then, all nerves attaching the system to the body and the buccal ganglia to the buccal mass were cut, so the system was isolated (see Fig. \ref{fig:methods_general}A). The preparation was immersed in a saline solution (in mM: 51.3 $NaCl$, 1.7 $KCl$, 1.5 $MgCl_2\cdot6H_2O$, 4.1 $CaCl_2\cdot2H_2O$, 5 $HEPES$, corrected to pH 7.8 with 4 $M$ $NaOH$).
The sheath above the ganglia that restricts the access to the neuron with the sharp electrode was reduced using \textit{Protease} (Sigma type XIV). All procedures followed the European Commission and Universidad Aut√≥noma de Madrid animal treatment guidelines.

\subsection{Spike waveform characterization parameters} \label{sec:characterization parameters}
\label{sect:metrics}
% Data analysis was performed in Python 3.8. 
For both experimental recordings and model simulations, action potentials were detected as the max point over a threshold, and each waveform was segmented 100ms before and after the peak temporal reference. For the superposition of action potentials (Figs. \ref{fig:continuous_results_panel},\ref{fig:continuous_model},\ref{fig:temperature model},\ref{fig:q10 dependency}) the waveforms were aligned in the x-axis by the peak and in the y-axis by the first point of the waveform voltage values.

For the waveform shape characterization, we used four different parameters: duration, amplitude, depolarization and repolarization slopes. They are depicted in Fig. \ref{fig:methods_general}B and defined as follows:
\begin{itemize}
    \item Duration: Time interval between the two points at half width of the action potential. 
    \item Amplitude: Difference between minimum and maximum voltage values in the waveform. 
    \item Depolarization slope: Slope in the depolarization phase measured 10 points before and after the half width point reference before the peak.
    \item Repolarization slope: Slope in the depolarization phase measured 10 points before and after the half width point reference after the peak.
\end{itemize}

To compare recordings from different neurons and between model simulations and experimental data, we normalized the change between the laser and the control for each metric using the following expressions for electrophysiological data and model simulations, respectively:
\begin{equation}
    {metric\ change}_{experimental} = \frac{|metric_{laser} - metric_{control}|}{|mean(metric_{control})|},
\end{equation}

\begin{equation}
    {metric\ change}_{model} = \frac{|metric_{min} - metric_{max}|}{|metric_{max}|}.
\end{equation}

All data analysis was performed in Python, the scripts are available in \href{https://github.com/GNB-UAM/Garrido-Pena_Modulation-neural-dynamics-by-CW-NIR-stimulation}{github.com/GNB-UAM/\\Garrido-Pena\_Modulation-neural-dynamics-by-CW-NIR-stimulation}.

\begin{figure}[htb!]
    \centering
    \includegraphics[width=\textwidth]{img/laser/Fig1_methods_general_w_temperature_estimation.pdf}
    \caption{A. Illustration of the laser beam focused on a neuron in the right parietal ganglia at maximum power showing a sharpened form due to the angle. B. Representation of waveform shape's metrics: a) Spike duration at half width. b) Spike amplitude between the maximum and minimum voltage values. c) Depolarization slope at half width. d) Repolarization slope at half width. C. Open-pipette temperature estimation method. Left column, temperature and voltage relation. Second column filtered mean of voltage recordings from short illumination intervals in the pipette. D. Simulation of the CGC-model representing the voltage dynamics during an action potential and the corresponding ionic currents defined in the model ($I_{NaP}$, $I_{INaT}$, $I_A$, $I_D$, $I_{LVA}$, $I_{HVA}$). The units in the y-axis (in relative values) are defined in the legend, respectively. E. Activity-dependent protocol scheme. Neurons were recorded intracellularly and processed in real-time with the RTXI software. Using the spike prediction algorithms, the shutter was triggered at the desired action potential phase illuminating the neurons for 58ms. F. Examples of illumination offset, defined as the time interval from the end of the illumination to the peak of the spike.}
    \label{fig:methods_general}
\end{figure}

\subsection{Temperature estimation}
\label{sec:temperature-estimation}
To estimate the temperature of the laser effect, we used the open-pipette method employed in previous experimental studies to measure the temperature variation during the laser illumination \cite{Li2013, Rabbitt2016,Brown2020, Brown2021}. We calibrated the resistance and temperature relation using a thermistor (EPCOS, 10$k\Omega$) to measure the temperature in the preparation solution in the range from 23¬∫C to 29¬∫C. We used two protocols, injecting a constant current to calculate the resistance change with the voltage recording and with pulses of a specific current value. From the resulting recording slope of the linear regression, we computed the conversion from voltage to temperature. For the estimation of the temperature change during the laser stimulation, we measured the voltage change during short intervals of laser illumination and the temperature value at its saturation plateau. This estimation is represented in Fig. \ref{fig:methods_general}C.

\subsection{Continuous-wave NIR laser stimulation}
The experimental results presented here were obtained using a continuous-wave (CW) NIR diode laser in single TEM00 operation and 830nm wavelenght output (Integrated Optics 0830L-13A-NI-PT-NF). 
The diode laser output was coupled to a single-mode optical fiber to efficiently guide the laser beam to the sample. To adapt the divergence of the laser beam to the fiber optic output, an aspherical lenses-collimator (Thorlabs, F280FC-850) was installed. An achromatic doublet with focal length f=50mm was used to focus the laser beam on the sample (Thorlabs AC127-050-B-ML). The experiments were performed with a laser output power of 185mW and a power density over the sample of 5.3 kW/cm¬≤. The grazing incidence of the laser beam on the sample created a quasi-elliptical spot, with a minor axis of approximately 34{\textmu}m, as shown in Fig. \ref{fig:methods_general}A,.

The laser was attached to a micro-manipulator (Siskiyou MX160), allowing micrometers precision of the beam placement over the neuron and optimization of the beam focus. The focusing was performed using the binocular microscope (Nikon SMZ-1500) coupled to a CCD camera (XCAM1080PHA, ToupTek Photonics, Zhejiang, China).

For the activity-dependent stimulation, the CW laser light was blocked with a mechanical shutter (Thorlabs SH05, Newton NJ). The shutter was triggered with an analog signal received from the real-time detection via software (see Sec. \ref{sect:methods-activity-dependent} and Fig. \ref{fig:methods_general}E). The shutter had about 8 ms delay from the activation TTL trigger, which might be a limitation for neural stimulation in fast spiking cells. The neurons used for this research are compatible with this restriction since they have slow spike dynamics. The activity-dependent protocol was developed considering this limitation. 

\subsection{Sustained CW-NIR stimulation protocol}
\label{sect:sustained-protocol}
After the isolation of the \textit{Lymnaea stagnalis} neural system, we searched for a suitable neuron in the right parietal ganglion, i.e., neurons with spontaneous activity preferably with fast activity and shoulder or symmetrical type in the spike waveform. 
Once the neuron was identified, the laser was set-up. A lens with focal distance of f=50mm was used and no polarizer was installed on the optical path. Guided with the microscope camera, the laser spot was located and then placed first over the ganglion and subsequently over the specific neuron where the electrode was recording the activity. 
At this point, the laser was focused with the micro-manipulator adjusting the focal distance. Finally, the power of the laser was sequentially increased getting near to the laser limit $\sim$185 mW.

Once the laser spot was already over the neuron while the soma activity in the neuron was simultaneously recorded with the intracellular electrode, we followed the protocol described below to measure the effect of the CW-NIR laser on the activity of the neuron:

\begin{enumerate}
    \item First control. The spontaneous activity in the neuron was recorded for 1-3 minutes, depending on the spiking frequency of the neuron. During this control, there was no external modulation of the neuron apart from the possible alteration of the intracellular procedure.  
    \item Laser stimulation. The laser was on during the same lapse of time than in the first control, stimulating the neuron with a constant intensity. There was no modification in laser parameters during this time.
    \item Recovery. After the illumination was off, a second control was performed, under the same conditions as the first one. With this recovery control, the activity in the neuron after the effect of the laser was recorded.
\end{enumerate}

The sequence involving control, laser and recovery trials was replayed in each experiment (day and individual) for five times. Between each trial, the laser was supervised to ensure that the spot was still over the neuron, guaranteeing that the procedure had as low variation as possible. Also, the laser was only turned off during the controls, it was not set aside, since that would have forced to redo the set-up for every trial altering the reproducibility between trials. 

\subsubsection{Statistical Analysis}
\label{sect:statistical_analysis}
The statistical significance analysis in the data obtained from the sustained CW-NIR stimulation protocol was performed applying a paired T-test to the four spike waveform metrics characterized here (see Fig. \ref{fig:methods_general}B). Data from distinct experiments was gathered and paired by recordings of control-laser and control-recovery (see Fig. \ref{fig:continuous_results_panel}C). The null-hypothesis tested was that control group was equal to the laser group and that the control group was equal to the recovery group, respectively. Since we performed the test in the four metrics --spike duration, depolarization slope, repolarization slope and amplitude-- we applied the Bonferroni correction, thus we considered high-significance when $\rho < 0.01/4$.


\subsection{Neuron models}
\label{sec:model equations}
The theoretical study was carried out simulating the laser modulation on the neurons in three conductance based models: (i) the classic Hodgkin-Huxley model \cite{Hodgkin1952} defined by Eq. \ref{eq:hh}, composed of two cannels: $I_{Na}$ and $I_K$, and a leakage current; (ii), a N3t neuron model from \cite{Vavoulis2007}, with two compartments and defined by Eqs. \ref{eq:soma} and \ref{eq:axon}, which represents a neuron in the \textit{Lymnaea stagnalis}'s feeding CPG \cite{garrido-pena_characterization_2021}, and (iii) a model from \textit{Lymnaea stagnalis} which simulates the CGC neuron located in the cerebral ganglia with a shoulder type spike waveform \cite{Vavoulis2010}. This model is described by six different ionic channels: Persistent and transient sodium currents ($I_{NaP}$, $I_{NaT}$); transient and delayed rectifier potassium currents ($I_A$, $I_D$), and a low-voltage-activated and high-voltage-activated calcium currents ($I_{LVA}$, $I_{HVA}$), described by the Eqs. from \ref{eq:voltage} to \ref{eq:channels}. The CGC neuron model is the most complex one and the one used for the temperature dependence study.  Figure \ref{fig:methods_general}D displays the dynamics of each channel in this model during an action potential.


\begin{equation}
    C_m\frac{dV}{dt} = I_{inj} - I_{Na} - I_K - I_L,
    \label{eq:hh}
\end{equation}

\begin{equation}
    \tau_m\frac{dV_S}{dt} = i_{inj} - i_{L,S} - i_T - i_{ec,S} - i_{syn}\\,
    \label{eq:soma}
\end{equation}
\begin{equation}
    \tau_m\frac{dV_A}{dt} = -i_{L,A} - i_{NaT} - i_K - i_{ec,A},
    \label{eq:axon}
\end{equation}

\begin{equation}
    C_m\frac{dV}{dt} = I_{inj} - I_{NaT} - I_{NaP} - I_{A} - I_{D} - I_{LVA} - I_{HVA},
    \label{eq:voltage}
\end{equation}

\begin{equation}
I_{NaT} = g_{NaT} m_{\inf}^3 h (V - E_{Na}),
\end{equation}
\begin{equation}
I_{NaP} = g_{NaP} r^3 (V - E_{Na}),
\end{equation}
\begin{equation}
I_{A} = g_{A} a^4 b (V - E_{K}),
\end{equation}
\begin{equation}
I_{D} = g_{D} n^4 (V - E_{K}),
% \label{eq:channels}
\end{equation}
\begin{equation}
I_{LVA} = g_{LVA} c_{\inf}^3 d_{\inf} (V - E_{Ca}),
\end{equation}
\begin{equation}
I_{HVA} = g_{HVA} e^3 f (V - E_{Ca}).
\label{eq:channels}
\end{equation}

\subsubsection{Temperature dependence in the model}
\label{sec:model equations temperature}
In order to have temperature dependent simulations, a $Q_{10}$ factor was incorporated to every dynamical equation in the model (i.e., conductances and activation gates). $Q_{10}$ represents temperature sensitivity in each channel and it was included as a new factor as shown in Eqs. \ref{Q10_conductance} and \ref{Q10_gates}, with $i=Na_T,Na_P,A,D,LVA,HVA$ for Eq. \ref{Q10_conductance} and $i=h,r,a,b,n,d,e,f$ for Eq. \ref{Q10_gates}. The capacitance was also defined as temperature dependent ($C_T$) with a linear relation to the difference of temperature: 

\begin{equation}g_i(T)=\bar{g}_i{Q^i_{10}}^{\frac{T-T_0}{10}},
\label{Q10_conductance}
\end{equation}
\begin{equation}\phi_i(T)=\bar{\phi}_i{Q^i_{10}}^{\frac{T-T_0}{10}},
\label{Q10_gates}\end{equation}
\begin{equation}C_T=c_0 + c_0 \gamma(T-T_0).\end{equation}

\subsection{Activity-dependent laser stimulation protocol} 
\label{sect:methods-activity-dependent}

For stimulating the neurons depending on their ongoing activity, a closed-loop protocol was designed in the RTXI real-time software \cite{Patel2017}. This hard real-time tool allows an easy integration of new modules to read ongoing activity, process it and send feedback in the form of analogue signals. The module designed for this experiment followed the scheme illustrated in Fig. \ref{fig:methods_general}E. After processing the signal in RTXI, a TTL pulse was sent to the controller opening the laser shutter for the desired time, and thus stimulating the neuron during that time interval. Simultaneously, the neural activity was recorded, along with the TTL and the shutter feedback (recording the shutter delay with respect to the on signal).

The main challenge in this protocol is the identification of the specific phase of the spike waveform to deliver the stimulus, i.e., predicting the spike, since spontaneous neural activity has intrinsic variability that requires the online adaptation of specific thresholds instead of a hand-tuned preset value. For this purpose, the protocol relied on the reference values from the previous spike at a specific time interval from the peak. The voltage threshold was calculated based on the voltage value measured in the previous spike, and recalculated at each spike. After each spike, the threshold for the spike prediction was updated using the following equation:

\begin{equation}
    \centering 
    V_{threshold}=V[t_{spike}[i-1]-\tau],
\end{equation}
    
\noindent with $\tau$ being the selected time for the prediction before the spike and $t_{spike}$ the time instant of the spike peak.

This prediction is effective for thresholds in the depolarization slope, since the spike is so stereotyped, but also for neurons with low or non-existent subthreshold activity, but it is limited in other scenarios. Therefore, for neurons or action modes of the same neuron when it was necessary to stimulate before the depolarization raise, another reference was used: the area of the recorded voltage. In this other mode of the protocol defined in Eq. \ref{eq:area}, the voltage was accumulated along the activity and the sum was reset after each spike. 

\begin{equation}
    \centering 
    V_{area}=\int_{V[spike_{i-1}]}^{V[spike_{i}]}V(t).
    \label{eq:area}
\end{equation}

The stimulation was triggered when the area reached a specific threshold, which was predicted as in the voltage case, or hand-tuned. For the detection of the minimum point to reset the voltage area, we used a RTXI module based on RTHybrid, a real-time software that includes automatic adaptation algorithms to handle the ongoing variability of the recordings \cite{Amaducci2019,Reyes-Sanchez2020,REYESSANCHEZ2023}, \href{https://github.com/GNB-UAM/rthybrid-for-rtxi/tree/master/rthybrid_burst_analysis}{github.com/GNB-UAM/RTHybrid-For-RTXI}. The use of each mode of the protocol in the experiment was decided depending on the specific requirements of the recorded activity. 


Using this detection protocol, we assessed the effect of the illumination at different spike phases in the range from 100 ms before the spike peak to 80 ms after the spike peak. The illumination interval was 58 ms, since it was the most effective one in the test trials. The RTXI module is available in \href{https://github.com/GNB-UAM/spike_predictor}{github.com/GNB-UAM/spike\_predictor}.


\section{Sustained CW-NIR laser stimulation effect on single neuron dynamics}
\subsection{CW laser effect on spike waveform}
In this paper we performed experimental triplets of control, sustained CW-NIR laser stimulation and recovery recordings (for details see Sec. \ref{sect:sustained-protocol}). This protocol provided a reference for the characterization of the laser effect. The data analyzed in this section corresponds to the spontaneous activity of neurons from the right parietal ganglion (RPG) of \textit{Lymnaea stagnalis}, under no stimulation other than the laser illumination when specified.

Left panels in Fig. \ref{fig:continuous_results_panel}A and B illustrate the stereotyped waveform of the action potential from two experiments in two distinct neuron types present in the RPG with shoulder and symmetrical spike shapes, respectively. Note that the two neuron types differ not only in spike waveform but also in duration. In the example shown in Fig. \ref{fig:continuous_results_panel}A, the duration of the spike was $\sim$20 ms whereas the one shown in Fig. \ref{fig:continuous_results_panel}B was $\sim$40-50 ms. To characterize the sustained CW laser stimulation in terms of change and recovery, the three stages of the protocol --control, laser and recovery-- are represented in all panels. The superimposition of the spike waveforms ($\sim$40 and 110 spikes for each trial, panels A and B, respectively) for the same recording are aligned in the $x$ axis by the spike peak and in the $y$ axis by the voltage amplitude of the first point of the waveform, together with the trial mean spike represented with a wider line. Note how the control and recovery traces overlap for both neuron types, illustrating the resumption of the spike dynamics shortly after the laser stimulation ceases (see aligned spikes in Fig. \ref{fig:continuous_results_panel} A and B).

Figures \ref{fig:continuous_results_panel}A and B illustrate that the variability was very small in amplitude, duration and in depolarization or repolarization slopes between the spikes within the same trial in both neuron types. However, during CW-NIR laser stimulation, the change in action potential waveform shape was notable with respect to the control and the recovery. This change was most clear in the spike duration, which was the result of changes in both depolarization and repolarization slopes. 

\begin{figure}[htb!]
    \centering
    \includegraphics[width=\textwidth]{img/laser/Fig2_continuous_results_panel.eps}
    \caption{Effect of sustained CW-NIR laser stimulation on the spike waveform for two distinct neuron types. For all panels: control, laser and recovery are color coded in blue, red and green, respectively. Panel A. Characterization of no shoulder shape type neuron. Panel B. Characterization of shoulder shape type neuron. Ai) and Bi) Superimposition of spike waveforms in a single trial recording corresponding to a symmetrical and shoulder spike neuron, respectively. The spikes were aligned to the peak for the $x$ axis and to the onset for the $y$ axis, the mean is depicted in darker colors. Aii) and Bii) barcharts that quantify the change using the difference from laser to control normalized by the mean control value for metrics: duration, depolarization and repolarization slopes, and amplitude. Panel C, violin plots representing the variation of the experiments with respect to the control (N=23) for shoulder and symmetrical types together. For each metric of the waveform, control, laser and recovery, all normalized to the first control. From left to right: duration, depolarization slope, repolarization slope and amplitude. Asterisks over the violins indicate that the metric change was highly significant (Bonferroni correction, ($\rho<0.01/4$), see Statistical Analysis section \ref{sect:statistical_analysis} in Materials and Methods).}
    \label{fig:continuous_results_panel}
\end{figure}

The right panels ii) in Fig. \ref{fig:continuous_results_panel}A and B, show barcharts that quantify the change in terms of spike duration, amplitude, depolarization slope and repolarization slope. These metrics were used to characterize the action potential waveform and its possible change during the laser illumination (see also Fig. \ref{fig:methods_general}B and Sec. \ref{sect:metrics}). Each one of these metrics is represented on the right panels as the absolute value of the difference of the laser stimulation to the control recording normalized by the mean control value (see Sec. \ref{sect:metrics}). For both neuron types there was a change in duration and in the slopes, with the largest change being in the repolarization slope (around 26\% for the symmetrical spike type neuron and 86\% for the shoulder type). The alignment illustrated in the left panels shows that the change in amplitude was minimal in comparison to the rest of the metrics. Although both neuron types showed an effect of the sustained CW laser stimulation in the action potential waveform, the change in the shoulder neuron type was larger for duration and slopes. This may be due to specific channels that generate the shoulder shape of the spike, which may allow for a wider range of change in the spike dynamics, especially in terms of the repolarization slope. 


Panel C in Fig. \ref{fig:continuous_results_panel} displays the results of multiple experiments following the same protocol described above, represented in violin plots as the normalization of each experiment with respect to their control mean for each spike in control, laser and recovery. To avoid possible bias from the natural evolution of the intracellular recordings, in this figure we only included experiments where the activity was recovered within 10\% change in firing rate with respect to the control. For each trial, only stereotyped waveforms were considered and large deviations (in the form of $z_{score} < -0.1$ in the normalized duration) were filtered out. The variability characterized in the control violins represents the variation within controls, which was also the most homogeneous in terms of density distribution. This is represented for each one of the selected spike waveform characterization parameters as in panels A and B --duration, depolarization slope, repolarization slope and spike amplitude (see Fig. \ref{fig:methods_general}B).

The results shown in Fig. \ref{fig:continuous_results_panel}, panel C are consistent with the described change in the illustrative individual experiments shown in panels A and B in the same figure. On the one hand, the activity recovered its initial characteristics after the CW laser stimulation ceased, since the recovery violin returned to the same level as the control. This can be seen in every metric, the green violin is at the same mean level value as the control. The differences in the distributions are caused by the natural variability in the biological system. Also, as all values are normalized to the mean of the first control, it can be expected that the distributions may diverge more in laser and recovery violins than in control violins. See the segregation of the analysis of the two neuron types [Fig. S1 in the Supplementary Material]

Regarding the change during the laser stimulation, for every parameter except amplitude, we can see how the overlapping of the distributions is minimal. The distribution for the duration was the most homogeneous, whereas the variation for depolarization and repolarization slopes had different density distributions, being the repolarization slope the one presenting a larger change in most cases. This can be explained by the variety of neurons in the collected data, the change in the slopes differed from one type of neuron to another. Thus, the distribution of variability was different. Some laser stimulation recordings presented a milder change than others. The slight change along neurons of the same type was likely due to the physical restrictions of the setup in each experiment: the angle of the laser, the laser focusing, the maximum power used and the overlaying tissue. Overall, considering these factors, we can see that stimulating with the CW-NIR laser resulted in a significant change of the spike waveform. In the case of the amplitude, the change was very small. 

We performed statistical tests on these data and confirmed that the changes in duration, depolarization and repolarization slopes were highly significant ($\rho < 0.01 /4$) when comparing control and laser samples. The amplitude change was not highly significant, and so were not the changes in any metric comparing control and recovery samples (see Statistical Analysis section \ref{sect:statistical_analysis}).

This combination of changes points out to different biophysical candidates that might be involved in the modulation, such as capacitance, for the global change in both slopes or specific channels involved in the CW-NIR laser effect, since the deporalization and repolarization slopes were affected differently, while the amplitude did not change, and for distinct neuron types the characterized metrics had different variations (i.e., the repolarization slope in the shoulder shape neuron type was reduced to a greater extent than in the symmetrical type). Bellow we assess these possible candidates using a computational model. 

\subsection{CW laser effect on spiking rate}
During the identification of the biophysical effect at different phases of the action potential dynamics on single neurons, we identified a robust acceleration of the action potential (a shorter duration of the spike waveform). This could also point to an acceleration of the tonic activity of the neurons. Pulsed near infrared laser stimulation has been proven effective as a stimulation technique, mainly eliciting action potentials (APs) in silent neurons at specific combinations of pulse duration and intensity \cite{Wells2005, Shapiro2012, Izzo2007, Cayce2014}. Thus, we also assessed the effect during sustained CW-NIR infrared laser stimulation on the spiking frequency in long stimulation recordings (1-3 min). 

To avoid possible bias originated from intrinsic properties of the neuron and the circuit in which it was integrated, we only considered recordings where the neurons effectively recovered their control activity rate after the stimulation (i.e., absolute recovery change within 10\% from the initial control). The activity frequency was characterized by the absolute firing rate for control, laser and recovery, and by a histogram of Inter Spike Intervals (ISIs), i.e., the time interval from peak to peak.

\begin{figure}[hb!]
     \centering
     \includegraphics[width=\textwidth]{img/laser/frequency.pdf}
     \caption{Firing rate and interspike interval (ISIs) analysis for the CW-NIR laser stimulation. A. Absolute firing rate in all experiments (N=23). B. Absolute firing rate for cases from A with no change during laser illumination (N=11); C. Absolute firing rate for experiments from A showing an increase in the firing rate (N=12); D. ISI histograms for control, laser and recovery for each experiment. Cases showing increased excitation in their firing rate (sample in panel C) when illuminated by the CW-NIR laser are highlighted in a red square. Only experiments in which the recovery was within 10\% of the initial control were taken into account for this analysis.}
     \label{fig:frequency FR}
\end{figure}

In Fig. \ref{fig:frequency FR}, the mean firing rates for control, laser and recovery are represented along with their standard error of the mean. Panel A depicts the general change in frequency for the neurons, showing the neural activity trend to excitation in the mean. In panels B and C, this set of triplets is divided into two groups depending on the difference between the laser and the control, classified as no change when the difference between control and laser was less than 10\% (panel B), and as excitation for the opposite case (panel C). It is important to point out that there is no representation of inhibition in this panel, since there was not any experiment that fulfilled the criteria of a 10\% negative change during the laser stimulation with respect to the control. Note how cases where the activity increases are the most consistent ones (12 out of 23) and that even in the set classified as unchanged, the mean of the AFR during laser stimulation is larger than the controls. These results support an excitatory tendency during continuous-wave NIR sustained stimulation.

The absolute firing rate hinders some characteristics of the neural activity, such as the refractory period or the presence of bursting activity, which might also influence the firing frequency study. Thus, Fig. \ref{fig:frequency FR}D displays the ISI histogram for each experiment showing again the triplets of control, laser and recovery, for each sample. Experiments showing excitation are highlighted in a red square. Note that for most cases classified as excitation, the ISIs tendency is to be reduced, which is observed in the laser histogram at the left of the control and the recovery. Note that there are some experiments where the laser ISI histogram seems to overlap with the controls and the recovery (see Fig. \ref{fig:frequency FR}D, panels [2,A] [3,A] and [2,C]) but still the mean FR of the laser recording was 10\% higher than the control. In these situations, even though the activity was faster under stimulation, the time between spikes did not show a proportional change, which can be due to a modulation in the refractory period that compensated the spike acceleration. Under the laser modulation, we also found that some neurons would start firing in shorter ISIs, tuning the tonic spiking into pair spiking similar to small bursts, e.g. Fig. \ref{fig:frequency FR}D, panel [2,F].

Overall, our results in this section show a larger tendency to a frequency increase in response to the NIR illumination indicating that it is possible to achieve neuronal excitation under sustained CW-NIR laser stimulation. It is also important to highlight that inhibition was not found in any of these experiments with sustained CW-NIR laser stimulation during tonic firing activity. 


\section{Model analysis for constraining candidates to explain the effect of CW-NIR laser illumination in the spike dynamics}
\label{sect:models}
Computational models are a powerful tool to assess the source of neural dynamics where all variables involved are accessible. By considering membrane potential recordings alone, it is difficult to understand the contribution of the biophysical candidates in the underlying dynamics shaping the action potential. While it is specially hard to carry out experiments using chemical and/or electrophysiological techniques to block or compensate channels to mimic the observed CW-NIR laser effect, the simultaneous accessibility to all the variables in a model provides a unique tool to dissect the contribution of all biophysical candidates. Thus, to further explore the source of the experimentally observed CW-NIR effect, we analyzed the spike generation dynamics in three different conductance-based models assessing the change in the most likely candidates to be affected by the laser stimulation: modulation of membrane capacitance and ionic channels. More specifically, we modulated the capacitance and the conductance of the active ionic channels --$I_{Na}$ and $I_{K}$ in the standard Hodgkin-Huxley (HH) model \cite{Hodgkin1952}; the conductance of ionic channels --$I_{NaP}$,~$I_{NaT}$,~$I_{D}$,~$I_{A}$,~$I_{HVA}$,~$I_{LVA}$-- and capacitance in a \textit{Lymnaea stagnalis} CGC neuron model with a shoulder shape waveform \cite{Vavoulis2010}; and the capacitance in a two-compartment model --where the fast and slow dynamics are segregated-- in a \textit{Lymnaea stagnalis} buccal ganglion neuron (N3t) model \cite{Vavoulis2007}. The implementation of these models is available in the open-source model library Neun \href{https://github.com/GNB-UAM/neun}{github.com/GNB-UAM/Neun} and the code for the simulations can be accessed in \href{https://github.com/GNB-UAM/Garrido-Pena_Modulation-neural-dynamics-by-CW-NIR-stimulation}{github.com/GNB-UAM/Garrido-Pena\_Modulation-neural-dynamics-by-CW-NIR-stimulation}.

%Acordarse de poner en el GitHub que citen el art√≠culo si utilizan las librer√≠as

The model parameters were modulated to investigate and compare their effect to that of the CW-NIR laser stimulation on the neurons, and to evaluate the interrelationship between the observed changes. To identify changes in the spike dynamics similar to those observed under the CW-NIR laser illumination, we covered a complete range of values in the parameter space of each biophysical candidate. The criteria for driving the parameter exploration were the preservation of tonic spiking in the activity and the assessment of a realistic range of values.
As our initial hypothesis did not assume that the CW-NIR laser effects were exclusively photo-thermal, model parameter changes were applied with no temperature description. Further down in Sec. \ref{sect:temperature model} we present a detailed study considering the temperature dependency of the biophysical candidates. 

\begin{figure}[hbt!]
     \centering
     % \includegraphics[width=0.\textwidth]{img/laser/continue_model_w_stats_table.pdf}
     \includegraphics[width=0.90\textwidth]{img/laser/continue_model_w_stats_table_purple.eps}
     
     \caption{Modeling study of the CW-NIR laser stimulation effects due to isolated biophysical changes that alter the spike waveform. Panels A, B, C and D: Superposition of spike waveforms in each model by modulating a single biophysical candidate. The background colors correspond to each simulated model. In Panel A, the capacitance is changed for the HH and CGC neuron models, and in the two compartments for the N3t neuron model. Panel B shows the spike waveforms changing the conductances of $Na$ channel currents: $I_{Na}$ from the HH-model, $I_{NaP}$ and $I_{NaT}$, from the CGC-model. Panel C, displays the modulation of $K$ conductances in ionic currents: $I_{K}$ in the HH-model and $I_{D}$ and $I_{A}$ for the CGC-model (from left to right). Panel D shows the modification of the calcium current conductances in the CGC-model ($I_{HVA}$ and $I_{LVA}$). Table in panel E represents the quantification of the changes in the spike metrics when tuning each parameter. Each value is the change normalized to the maximum. The color gradient range is specific for each column based on the experimental results. White and dark purple correspond to high and low similarity to the experimental change in relation to the experimental results, respectively.}
     \label{fig:continuous_model}
\end{figure}

The results of this study are shown in Fig. \ref{fig:continuous_model}. The analysis for each model is sorted by the explored biophysical candidate --capacitance, sodium channels, potassium channels and calcium channels--. Thus, panels A, B, C and D show the superposition of all spike waveforms from the simulations for the range of explored model parameter values of each candidate. Panel E shows a table with the quantification of the normalized change for each metric and biophysical candidate where the color code represents the ability of each parameter modulation to produce results similar to the change in the experimental results. For each metric, the change from minimum to maximum was normalized with the maximum value (analogously to the quantification in Fig. \ref{fig:continuous_results_panel}, see also Sec. \ref{sect:metrics}). The color gradient (represented in the color bar) takes as reference the experimental estimated change for both symmetrical and shoulder type neurons displayed in Fig. \ref{fig:continuous_results_panel}A and B, respectively. We considered as not similar a 20\% deviation below and 30\% over the range of the experimental changes. For the amplitude gradient, we only considered the reference of the deviation over the range, since the experimental change observed was minimal for both neuron types.

\subsection{Change in Capacitance}
Capacitance has been one of the most discussed biophysical candidates to be affected by IR laser illumination \cite{Shapiro2012, shapiro_correction_2017,Cayce2014, Plaksin2018}. A change in capacitance has a direct effect on the spiking frequency and exerts a global modulation on all ionic currents, so many studies have discussed this change both experimentally and theoretically.
Here we explored the CW-NIR modulation of capacitance in three different conductance-based models: in the Hodgkin-Huxley model, used in other studies, in the CGC-Vavoulis model, which presents a variety of channels and in the N3t-model, which is the only one with more than one compartment and, thus, has two distinct capacitance values. 

Figure \ref{fig:continuous_model}A displays the waveforms of each simulation. In the case of the HH-model, there was a mild change in duration, mainly caused by the depolarization modulation, and a change in amplitude larger than what was observed experimentally. The CGC-model exhibited a similar tendency to the HH-model but with an extreme case at a low value of capacitance $0.5 \mu F/cm^2$, where moderated changes in depolarization and amplitude were combined with a large change in the repolarization, and consequently in the duration. This modulation made capacitance a better candidate for reproducing the experimental results in the case of the CGC neuron. In the N3t neuron, we can see contrasting results for the two different compartments. In the compartment containing slow currents, the change in amplitude was the most striking, seemingly conditioned by both slopes. In the case of the fast current compartment the main change was observed in repolarization rather than depolarization, which is more similar to the experimental outcome. 

These results are quantified in the table in Fig. \ref{fig:continuous_model}E. The HH-model showed a change comparable to the experimental one only for the depolarization slope. The CGC-model reached plausible values in terms of duration and repolarization, but in terms of depolarization, it exceeded both experimental references (dark purple). The change in amplitude was larger than seen in the experimental results for most parameters. It is especially clear in the case of the two-compartment model (N3t neuron), in which the modulation of capacity in the slow compartment resulted in a large change in amplitude. In contrast, the change in amplitude in the fast compartment was the only one in the similarity range with respect to the experimental results.

By changing the capacitance, we achieved some of the expected changes, but achieving the desired results for all four metrics simultaneously was not possible. Therefore, modulating capacitance alone does not reproduce the experimentally observed effects, especially regarding the combined change, e.g., large change in repolarization and small change in amplitude, larger change in repolarization than in the depolarization. It was only when the fast compartment of N3t was modified that relations between these four metrics matched the above relationships. But note that changing the capacitance in the slow compartment is equivalent to changing several ionic currents simultaneously, not just a single current property. 

\subsection{Ionic channels}
The other mechanism to explain the laser modulation that we assessed here was a direct effect on the ionic channels involved in the generation of action potentials. These channels are activated in a sequential manner, and each of them is directly involved at distinct stages of the action potential generation. They have been discussed in the laser stimulation literature \cite{Liang2009,Li2013, Rabbitt2016} by a direct effect of maximal conductance, and channel opening and closing dynamics due to thermal effects, e.g., in calcium channels \cite{Albert2012, Barrett2018}. These candidates were assessed here in the two single compartment models, the HH-model due to its wide use in computational neuroscience and the Vavoulis-CGC model for its variety of channels (including calcium currents) and accurate reproduction of the observed neural waveform shape. Note that in the CGC-model analysis, all currents types are in pairs of high and low conductance as well as fast and slow dynamics, having two currents for sodium, potassium and calcium (see Fig. \ref{fig:methods_general}D in Materials and Methods).

In Fig. \ref{fig:continuous_model}B the spikes from the simulations for each sodium current in the HH and CGC models --$I_{Na}$, and $I_{NaP}$ and $I_{NaT}$, respectively-- are superimposed. For the three currents, we observed modulation in both depolarization and repolarization slope, which resulted in a change in duration. Although the change in duration is close to the experimental outcome, the change in the depolarization is larger than in repolarization (see Fig. \ref{fig:continuous_model}E), which is contrary to the experimental results, as it is also the change in amplitude for $I_{Na}$, and $I_{NaP}$. However, for channel $I_{NaT}$ the change in amplitude was smaller, falling into the experimental range for amplitude and duration, but the change in depolarization exceeded the experimental range and the repolarization change was limited in the context of shoulder type neurons. Although the change of sodium channels alone generated a similar change in duration in relation to the experimental results, the rest of the metrics did not replicate those results.

Analogously, in Fig. \ref{fig:continuous_model}C, simulations for potassium currents ($I_K$ and $I_D$ and $I_A$, respectively) are represented for HH and CGC models. For the three currents, the major change was in the repolarization slope followed by the depolarization (see quantification in Fig. \ref{fig:continuous_model}E). This combination resulted in a modulation of the duration that lay in the range of similarity to the experimental results, with the exception of the amplitude, which does not correspond to the experimental results. It is especially applicable in the case of $I_K$ in HH-model and in the conductance of the strong potassium current $g_D$ of the CGC-model. Note that for the $I_A$ current, although the changes were comparable to the experimental change, their range was not, so a change in this current alone was not considered a plausible candidate. Thus, a change in potassium channels reproduced the experimental results for duration and the two slopes overall, but it was limited due to a change larger than expected in the amplitude.

In order to inspect the CGC-model in detail, we also simulated the changes in the calcium currents --$I_{HVA}$ and $I_{LVA}$-- for this model. These currents have a key role in the generation of the shoulder shape in the spike (Figure \ref{fig:continuous_model}D). Both created a similar change in the repolarization slopes, as well as in the depolarization, which is also close to the experimentally observed modulation. For duration, $I_{HVA}$ better matched the change, but this modulation was also accompanied by a large change in amplitude which was not observed in the experimental results. On the other hand, $I_{LVA}$ had a minimal effect on amplitude but, contrary to experimental results, its effect on the duration was also minimal, although the depolarization and repolarization slopes had a comparable change to the experimental observations. Therefore, altering each calcium channel effectively reproduced the desired change in the slopes but the modulation in duration and amplitude occurred in the same proportion, which does not match the experimental results.

The results described in this section indicate that each candidate can be modulated to bring the waveform closer to the experimentally observed results, but when changed separately they account only for a partial set of metrics matching. The desired combination of changes for duration, slopes and amplitude was not achieved by tuning only one parameter at a time. However, some of the candidates came close to this combination. Considering the ionic current candidates, the one that was closer to the \textit{in vivo} stimulation was potassium current, which reproduced a large range of change in the repolarization, depolarization and duration, though exceeding the change in the spike amplitude. This is important in terms of the interrelation of the metrics. Considering the range of change reached, the calcium channels where the best candidates for the reproduction of the experimental repolarization slope modulation, allowing a wide range of values and generating the shoulder shape waveform. We also saw how capacitance in single compartment models was not enough to reproduce the results. It was only when the capacitance was modified separately in two compartments, that the change reproduced the CW-NIR laser stimulation better. This points to a mechanism for explaining the CW-NIR laser effect with contribution from several candidates at the same time where specific factors might be of greater importance, such as the potassium channel in the case of shoulder shape neurons.

\subsection{Change of spike dynamics considering temperature modulation in the model}
\label{sect:temperature model}
Most studies in laser stimulation point out to a photo-thermal effect, e.g. see \citenum{Wells2007, Shapiro2012, Li2013, Rabbitt2016, Ganguly2016, Cury2021, Pan2023}. Thus, in this section we include a model analysis with temperature modulation. We selected the CGC-model from Ref. \citenum{Vavoulis2010} since it is the richest model in terms of variety of channels and ability to mimic the spike waveform of shoulder type neurons. To study global temperature dependence in the model we added a $Q_{10}$ coefficient, representing the temperature sensitivity in the model parameters. The $Q_{10}$ value chosen was 3, as an average general value used in the literature \cite{hodgkin_effect_1949,Li2013,Shapiro2012, Rabbitt2016,Ganguly2019b}, also proposed as a universal value for $Q_{10}$ \cite{elias_universality_2014}. We estimated the temperature change under laser stimulation at maximum power following an open-pipette method, with a resulting temperature increase of 1-2¬∫C (see Sec. \ref{sec:temperature-estimation} and Fig. \ref{fig:methods_general}C). Note that our CW-NIR laser wavelength is at one of the lowest absorption bands of water, so the open-pipette method probably under estimates the change in temperature in the neuron, being the change in the temperature caused not only by water heating but also by heating the tissue. In addition, the reported temperature range of laser induced variation in the literature is wide, depending on the system, the estimation technique and whether it comes from a model or an \textit{in vivo} estimation \cite{Shapiro2012, Rabbitt2016, Thompson2012}. Therefore, in our simulations we explored a wider range than our experimental estimation, considering 5¬∫C as a reference and the quantification of the change up to 10¬∫C.

\begin{figure}[hbt!]
     \centering    
    \includegraphics[width=\textwidth]{img/laser/Q10_waveform_change.pdf}
    \caption{Waveform change in the CGC-model due to $\Delta T$ temperature variation. Panel Ai) shows the spike waveform superposition at distinct temperature values. Spikes are aligned to the initial value of each waveform. In panel Aii) the normalized change in the waveform is depicted for all metrics (duration, depolarization and repolarization slopes and amplitude). Panel B shows how much the normalized metrics changed in response to temperature variation from 1 to 10¬∫C ($Q_{10}=3$).}
    \label{fig:temperature model}
\end{figure}

Figure \ref{fig:temperature model} shows the change in the spike waveform caused by variations in temperature. The $Q_{10}$ factor was added to every dynamical equation in the model (i.e. conductances, activation gates and capacitance, see Sec. \ref{sec:model equations temperature}). In panel A, we show the changes in the waveform for $\Delta T=0-5^{\circ}C$, represented as superimposed waveforms in Ai), and its quantification in Aii) normalized to the maximum, which is analogous to the previous sections (see Figs. \ref{fig:continuous_model} and \ref{fig:continuous_results_panel}): $|max-min|/|max|$. Note how both the spike waveform shape and the quantification of the changes are similar to the experimental results. We can observe changes in duration, depolarization and repolarization slopes, with a very small change in amplitude. The modulation obtained by combining these parameters was not achieved by tuning them separately. It is important to highlight that as the temperature increased (red lines), the spike got narrower by the corresponding alteration in slopes and duration, which supports the hypothesis that the observed effect in single neurons of \textit{Lymnaea stagnalis} might be, to a large extent, caused by temperature gradient. In panel \ref{fig:temperature model}B, there is a comparison of different temperature changes for the same $Q_{10}$ value in the model. Note that the relation of each parameter to the change in temperature is different, being the repolarization slope the one with the strongest relation, increasing much more rapidly than the duration or the repolarization slope. This points to a main role in the change from some of the channels, especially those that have more tolerance to change. This relation in the repolarization is similar to the comparison of the two neuron types analyzed in the experimental results (Figure \ref{fig:continuous_results_panel}A), where the main difference was present in the repolarization.

\begin{figure}[hbt!]
    \centering
    % \includegraphics[width=\textwidth]{img/laser/summary_simple_-1.pdf}
    % \includegraphics[width=\textwidth]{img/laser/Q10_parameter_no_dependency.pdf}
    \includegraphics[width=\textwidth]{img/laser/Q10_parameter_no_dependency_v2.eps}
    \caption{ Panel A. Waveform modulation in the CGC-model with temperature change in all channels except for one at a time, from top to bottom: $I_{NaT}$, $I_{A}$, $I_{D}$, $I_{HVA}$, $I_{LVA}$, respectively. Panel B. Specific cases of strong currents, simulations with no temperature dependency in $I_D$ and only with temperature dependency in $I_{NaP}$, respectively, where the waveform broke down when exploring the thermal change. For every row in both panels, from left to right: spike waveform aligned by the start of the waveform, and duration, slopes and amplitude metrics in the $x$ axis, and temperature in the $y$ axis, also represented with the color scale.}
    \label{fig:q10 dependency}
\end{figure}

To further explore these candidates and relations, we repeated the model simulation with temperature variations up to 5¬∫C but canceling the temperature dependency in one channel at a time. Note that overriding the temperature dependence of some of the channels at a time is only possible in a theoretical environment like this, which allows us to expose the role of each channel in relation to the temperature modulation. The results of this experiment are shown in Fig. \ref{fig:q10 dependency}, which is divided into two panels, depending on whether the suppression of the channel preserved the spiking shape (panel A) or broke the waveform (panel B). Panel A shows how the general spike waveform shape was preserved in the range of the tested temperature variations when individually excluding low potassium and calcium currents --$I_{A}$ and $I_{HVA}$ and $I_{LVA}$, respectively-- we were able to simulate the same range as in Fig. \ref{fig:temperature model} of $\Delta T=0-5 ^{\circ}C$. These three channel metrics presented a linear dependence on temperature. However, when excluding the temperature dependency of $I_{NaT}$, the model could not generate action potentials when raising the temperature for the other channels above $\Delta T=2 ^{\circ}C$, which suggests that $I_{NaT}$ intervention during the temperature modulation is relevant for the action potential generation. This channel presented a non-linear relation between the amplitude and the temperature. It is important also to note that suppression of the temperature dependency in $I_{HVA}$ in Fig. \ref{fig:q10 dependency}A resulted in a large change in the amplitude (20 mV decrease). This calcium current is needed to preserve the amplitude value while the slopes and duration values change during the temperature increase.


In Fig. \ref{fig:q10 dependency}B, we show two specific cases of current modulation: $I_{NaP}$ and $I_D$. First, we can see the simulation results when suppressing temperature dependency in $I_D$: it displayed non-linear relations and a large change in the waveform shape, modifying the duration along with the depolarization currents and thus breaking down the spike. This change corresponds to a strong role in the generation of the action potential for this channel. When excluding the temperature dependence from $I_{NaP}$, the spiking activity ceased, which also points to its strong role in the generation of the action potential. Thus unlike the previous panels, in this panel we provide the results of the simulation when only this channel had a temperature dependency. The results are, again, large changes in the spike waveforms with non-linear relations, emphasizing the necessity of a combined temperature modulation.

Exploring the waveform change during temperature variation showed that the most similar change to the experimental laser modulation was reached in the models with the temperature dependency description in all parameters. We showed that, for most currents as the temperature increases, the experimentally observed modulation relations were maintained, changing in duration and repolarization slope, with a larger change in repolarization slope and a mild change in amplitude. In addition, by excluding individual currents from the temperature dependency, we found a set of currents with similar roles in the temperature modulation of the spike waveform. This supports the hypothesis that the observed effect in the waveform due to the temperature variation was caused by a combination of candidates, with some of them playing a larger role than others. 


\section{Activity-dependent stimulation to assess the laser effect at distinct stages of the spike dynamics} 
\label{sec:activity dependent}
So far we have shown how sustained CW-NIR laser affects neural activity by modifying the dynamics of spike generation. In the previous section \ref{sect:models} we used a conductance-based model to theoretically assess the spike evolution and the different candidates involved in the modulation of the action potential generation (i.e., ionic channels and capacitance). To address this effect in an experimental setting is a complex task. Usually, it is accomplished using chemicals to block or open specific channels \cite{Liang2009}. This is not a generalizable method in different systems and individuals, and it restricts the channel study to a system with a detailed description of the specific neuron being recorded. We chose instead to assess the spike generation dynamics at different stages, which implies modifying the activity of several channels at a time in a precise timing relative to the spike generation dynamics. This task is only experimentally feasible with an activity-dependent stimulation protocol.
\begin{figure}[htb!]
    \centering
    \includegraphics[width=0.8\textwidth]{img/laser/activity_dependent_mean_boxplot_nocreative.pdf}
    \caption{Study of the laser effect at different stages of the spike waveform with an activity-dependent stimulation protocol. The panels quantify the change induced by the laser stimulation at distinct illumination offsets, --time intervals from the end of the illumination to the peak of the spike--. Top panel shows a spike from the experiment as a time reference for the offset --time 0 corresponds to the spike peak. Boxplots represent the difference of each metric with respect to the control. All illumination intervals had the same duration of 58 ms and spikes were grouped by the illumination offset, pictured in the blue boxes. Recovery and continuous laser reference are also shown in green and red boxes at left and right in the figure, respectively. The spike metrics selected here were duration, depolarization and repolarization slopes, --second, third and fourth rows, respectively.}
    \label{fig:activity dependent}
\end{figure}

In infrared stimulation literature, the most spread technique has been pulsed illumination which stimulates at a fixed frequency. Although this approach has been effective in some tasks such as eliciting neural activity, it has limited possibilities in the context of precision and adaptability. Thus, with the activity-dependent protocol proposed here, we also provide an open-access alternative to the widely-used fixed-frequency pulsed laser stimulation protocols, which usually depend on a specific combination of restrictions from manufacturers, controllers, and diode laser availability. In addition, a closed-loop approach provides further means to deal with the history-dependent nature of neural dynamics and its partial observability \cite{Varona2016a}. 


%This protocol provides not only an alternative to the stimulation, improving its precision, but also a solution for the generalization of NIR stimulation. 

Here we propose a closed-loop stimulation protocol where we can differentiate between the phases of the action potential, thus illuminating the neurons only at certain intervals of the spike generation dynamics with the activity-dependent stimulation. In this protocol, the laser illumination was controlled by a mechanical shutter triggered by the prediction of events in the voltage signal. A real-time software system ran the prediction algorithm and triggered the illumination for short periods of time at different phases of the spike generation when distinct channels were active (see Sec. \ref{sect:methods-activity-dependent} and Fig. \ref{fig:methods_general}E). The prediction of the events was computed by two algorithms, one based on a voltage threshold updated at each spike peak occurrence and a second one that calculated the voltage area from the hyperpolarization (minimum) to the next hyperpolarization. Based on this prediction the illumination was triggered at the specified time before the spike occurrence (see Sec. \ref{sect:methods-activity-dependent} for details in these algorithms). The implementation of these algorithms is available as a module for the real-time open-source system RTXI \cite{Patel2017} in \href{https://github.com/GNB-UAM/threshold-calculator-rtxi}{github.com/GNB-UAM/threshold-calculator-rtxi}.

Figure \ref{fig:activity dependent} shows the outcome of the application of this closed-loop protocol, with a stimulation interval lasting 58 ms. The time line in the figure represents the offset of the illumination, i.e., the time that corresponds to the end of an illumination interval to the peak of the action potential (see an illustration of the illumination offset in Fig. \ref{fig:methods_general}F). The offsets were in the range from 60 ms before the action potential peak up to 80 ms after its occurrence (this wide range is required because of the natural slow dynamics of \textit{Lymnaea stagnalis}'s neurons). Each row in the figure represents the change in relation to the mean of the respective control trials for every illumination range. The change is represented for the three metrics in which we observed modulation during sustained illumination --duration, repolarization and depolarization slopes, respectively--. The different stimulation intervals are grouped by the time offset from the illumination to the peak of the action potential. The spike shown in the figure is plotted as a reference of the phase of the action potential in which the illumination finished. Recovery and sustained laser references are also represented at the left and right of each row, in green and red, respectively. For the three metrics here displayed, we can see how as the illumination offset got closer to the spike, the change was larger, and then recovered as the illumination interval covered less the action potential, resulting in an arch shape trend. Although this trend is visible for the three parameters characterized, it is manifested to a different degree in each of them. Note also that there was a temporal shift of the laser effect depending on the instant of stimulation. The maximum change value and the initialization of the recovery was different for the depolarization and for the repolarization. The effect on each of these metrics directly depended on the spike phase when the laser was illuminating the neuron. Thus, this variation of the laser effect points to a distinct modulation on each channel. The magnitude of the change under the sustained laser stimulation was larger than that observed at any of the phases addressed with the activity-dependent protocol. This may be due to a heating delay during the stimulation, although there was no difference between the first and last spike in the sustained laser, the opening time of the laser shutter might have been smaller than the heating time necessary for the neuron to reach the maximum effect.

\begin{figure}[htb!]
   \includegraphics[width=\textwidth]{img/laser/general_error_mean_norm_to_off_n5.pdf}
    \caption{Normalized change for grouped values of spike duration, depolarization and repolarization slopes at distinct illumination offsets. Each value in each group was normalized to the mean of its corresponding day controls as minimum value and the mean of the continuous laser recordings for each day as the maximum value. The maximum value for each metric is marked by a black circle. }
    \label{fig:activity dependent error mean }
\end{figure}

Figure \ref{fig:activity dependent error mean } agglutinates the results from 5 different closed-loop experiments, all of them normalized to the mean of the control and sustained laser references for each day, as minimum and maximum values, respectively. The arch trend is maintained. Again, note that the maximum effect for each spike metric occurs at a different stage. For the depolarization, the maximum change was found at the range of -20 to 0 ms, which corresponds to a stimulation during the whole depolarization. A fast rise when the illumination ceased right after the spike can be seen (i.e (0-20] range), since it corresponded to a stimulation during the depolarization and repolarization. In the repolarization, this trend was slightly delayed, reaching the maximum difference from the control at (20-40]. Such changes were also reproduced in the duration. This points to a modulatory effect of the laser depending on the stimulation instant. Previous to -20 ms, the laser was illuminating the neuron while all ionic channels were starting to activate, specially those involved in the process of the depolarization. However, those channels involved in the repolarization and hyperpolarization were also active earlier than the peak. This is why we can see a difference in all three metrics even at the early ranges of the action potential generation (e.g. -80 ms).

Using the activity-dependent protocol we were able to assess the neural activity at different stages of its dynamics in a controlled way. The results from these experiments showed that it is possible to modify the action potential generation in a temporally precise manner and that the effect of the CW-NIR laser illumination is dependent on the instant of the stimulation. This sets the basis for assessing the biophysical sources of the effect impacting distinct channels without modifying the system condition. Also, it is a proof of concept demonstrating the possibility of developing laser stimulation protocols driven by specific neural activity events in an accessible and freely available real-time tool.


\section{The effect of computational neurons}
\section{Temperature change in neurons estimation using silver nanoparticles}