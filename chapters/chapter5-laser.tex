\chapter{CW-NIR laser as an effective neuromodulation technique}
\label{c-laser}

\section{Introduction}
\label{sect:intro}  % \label{} allows reference to this section

Effective neural stimulation is an essential tool to study brain dynamics. Many techniques have risen since the first use of electrical, chemical and mechanical stimulation, e.g., see Refs. \parencite{cogan_neural_2008, chamorro_generalization_2012, carter_guide_2015, bickle_revolutions_2016}. Optical methods are also widely spread, as they allow visualization \parencite{lecoq_wide_2019} and stimulation in a less invasive manner. One example is optogenetics \parencite{boyden_millisecond-timescale_2005, yizhar_optogenetics_2011, tye_optogenetic_2012,bansal_towards_2022}, which is effective in modifying neural activity with high spatio-temporal resolution. Another example of non-invasive stimulation is Transcranial Magnetic Stimulation \parencite{valero-cabre_transcranial_2017}, which is succeeding in clinical applications. However, they both present limitations such as the need to genetically modify the living system or restricted spatial precision, respectively. In this context, infrared laser stimulation is an optical technique that has risen in popularity in the last decade. From its first applications \parencite{wells_application_2005, izzo_optical_2007}, studies have shown its ability for modulating action potentials in different systems \parencite{liang_temperature-dependent_2009, goyal_acute_2012, brown_thermal_2020, barrett_pulsed_2018, shapiro_infrared_2012, cayce_infrared_2014, begeng_activity_2022}. Beyond its potential as a research stimulation technique, it has also been tested for clinical use, e.g., in Parkinson's disease, reversing brain age-related effects or depression treatment \parencite{konstantinovic_transcranial_2013, disner_transcranial_2016, wang_impact_2017, saucedo_transcranial_2021, pan_infrared_2023}. This neural stimulation method is so attractive because of the wide range of possibilities that can provide for non-invasive neuromodulation offering high temporal and spatial precision.
	
The identification of the biophysical source of infrared neuromodulation is still under discussion as it has strong implications for applications in multiple contexts. It is difficult to associate this modulation to a single specific cause, since neural systems have distinct biophysical components reactive to the irradiation. However, most of the results point to a photo-thermal effect where the excitation driven by the laser stimulation might be caused by temperature gradient \parencite{wells_biophysical_2007}. In addition, different candidates to explain the change in neural activity have been suggested, such as capacitance \parencite{shapiro_infrared_2012, plaksin_thermal_2018}, specific modulation of channels sensitive to temperature as TRPV4 \parencite{albert_trpv4_2012}, acceleration of ionic channels \parencite{liang_temperature-dependent_2009}, or altering the $Ca^{2+}$ cycle possibly mediated by modulation of mitochondrial activity \parencite{dittami_intracellular_2011, lumbreras_pulsed_2014, saucedo_transcranial_2021}.

Distinct types of infrared laser and action modes, in terms of the power, duration, frequency of stimulation and wavelength have been used in previous studies, see Refs. \cite{izzo_optical_2007, wells_application_2005,ping_targeted_2023}. The effect is highly dependent on the stimulation configuration. Most works have focused on pulsed lasers to induce spiking activity due to their stronger temperature gradient production. However, some clinical studies have successfully applied continuous-wave (CW) laser for brain stimulation \parencite{saucedo_transcranial_2021}.

The use of closed-loop techniques has a large potential in neuroscience, for both physiological and clinical research studies \parencite{potter2010, chamorro_generalization_2012, couto_firing_2015,lareo_temporal_2016,varona_online_2016,zrenner_closed-loop_2016,reyes-sanchez_automatic_2020,reyes-sanchez_automatized_2023}, since they allow adjusting the stimulation to the context of the ongoing neural dynamics and the specific condition of the targeted system/subject. Some of these tools have been developed with open-source approaches, including optical techniques, e.g. Refs. \parencite{siegle_neural_2015,dagnew_cerebralux_2017,amaducci_rthybrid_2019,stih_stytra_2019,robbins_optogenie_2021}, promoting the accessibility, reproducibility and standardization of the studies and methods. However, near-infrared (NIR) lasers have been used with fixed/periodic stimulus and, to the best of our knowledge, they have not been exploited in activity-dependent protocols. 

Here we explore the effect of CW-NIR laser on the dynamics of individual neurons in sustained and activity-dependent stimulation protocols. We employ a laser with constant optical power density on the sample for these two modalities. In the first case, the laser stimulation is sustained --the duration of the illumination is constant for more than 1 minute--, and in the second case it is driven in an activity-dependent manner implemented by the open-source RTXI\parencite{patel_hard_2017} Linux software --the onset of the stimulation is determined by ongoing neural events and delivered transiently through software control--.
We studied the effect of CW-NIR illumination focused on neurons with spontaneous tonic firing. Combining experimental results with modeling analysis allowed exploring the candidates that can explain the observed neuromodulation. We present a novel procedure for NIR laser stimulation to dissect and intervene in the waveform dynamics through activity-dependent stimulation. By interlacing results from theoretical simulations and sustained and activity-dependent stimulation, we identify the dynamical elements behind action potential dynamics under CW-NIR modulation. We discard any single candidate of the biophysical effect as the joint experimental and model analyses indicate that laser illumination affects multiple membrane factors simultaneously.



%\section{Results}

\section{Methods}
%\input{chapters/methods/methods-paper-laser}

\subsection{Sustained CW-NIR stimulation protocol}
\label{sect:sustained-protocol}
After the isolation of the \textit{Lymnaea stagnalis} neural system, we searched for suitable neurons in the right parietal ganglion, i.e., cells with spontaneous activity preferably with fast activity and shoulder or symmetrical type in the spike waveform. 
Once the target neuron was identified, the laser was set-up. A lens with focal distance of $f$=50mm was used and no polarizer was installed on the optical path. Guided with the microscope camera, the laser spot was located and then placed first over the ganglion and subsequently over the specific neuron where the electrode was recording the activity. 
At this point, the laser was focused with the micro-manipulator adjusting the focal distance. Finally, the laser power was increased to the above mentioned value for the experiments.

Once the laser spot was over the neuron while the membrane voltage was simultaneously recorded at the soma with the intracellular electrode, we followed the protocol described below to measure the effect of the CW-NIR laser on the activity of the neuron:

\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/trial-protocol.pdf}
	\caption{CW-NIR laser stimulation protocol sequence: Control, laser stimulation and recovery.}
	\label{fig:protocol scheme}
\end{figure}

\begin{enumerate}
	\item First control. The spontaneous activity in the neuron was recorded for 1-3 minutes, depending on the spiking frequency of the cell. During this control, there was no external modulation of the neuron apart from the possible alteration by the intracellular procedure.  
	\item Laser stimulation. The laser was on during the same lapse of time than in the first control, stimulating the neuron with a constant optical power density. There was no modification in laser parameters during this time.
	\item Recovery. After the illumination was off, a second control was performed, under the same conditions as the first one. During this recovery control, the activity in the neuron after the effect of the laser was recorded.
\end{enumerate}



The sequence involving control, laser and recovery trials was replayed in each experiment (day and individual) for five times. Between each trial, the laser illumination was supervised to ensure that the spot was still over the neuron, guaranteeing that the procedure had as low variation as possible. Also, the laser was only turned off during the controls, it was not set aside, since that would have forced to redo the set-up for every trial altering the reproducibility between trials. The effect for each trial of a given day was very similar. 


For the analysis in Figure \ref{fig:continuous_results_panel}, the trial with the strongest effect in the day was selected. \todo{mover a capitulo}



\subsection{Activity-dependent laser stimulation protocol} 
\label{sect:methods-activity-dependent}

For stimulating the neurons depending on their ongoing activity, a closed-loop protocol was designed in the RTXI real-time software \parencite{patel_hard_2017}. This hard real-time tool allows an easy integration of new modules to read ongoing activity, process it online and send feedback in the form of analog signals. The real-time module designed for this experiment followed the scheme illustrated in Fig. \ref{fig:activity dependent protocol}. After processing the signal in RTXI, a TTL pulse was sent to the controller opening the laser shutter for the desired time, and thus stimulating the neuron during that time interval. Simultaneously, the neural activity was recorded, along with the TTL and the shutter feedback (recording the shutter delay with respect to the on signal).

The CW-NIR laser light was blocked with a mechanical shutter (Thorlabs SH05, Newton NJ). The shutter utilized in this work had a $\sim 8$ ms delay from the trigger signal, which might be a limitation for neural stimulation in fast spiking cells. The slow spike dynamics in the neurons used for this research are compatible with this restriction and the protocol was developed considering this limitation. 


\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/activity_dependent_protocol.pdf}
	\caption{Activity-dependent protocol scheme. Neurons were recorded intracellularly and their voltage signals were processed in real-time with the RTXI software. Using the spike prediction algorithms, the shutter was triggered at the desired action potential phase illuminating the neurons.}
	\label{fig:activity dependent protocol}
\end{figure}


The main challenge in this protocol is the identification of the specific phase of the spike waveform to deliver the stimulus, i.e., predicting the spike, since spontaneous neural activity has intrinsic variability that requires the online adaptation of specific thresholds instead of a hand-tuned preset value. For this purpose, the protocol relied on the reference values from the previous spike at a specific time interval from the peak. The voltage threshold was calculated based on the voltage value measured in the previous spike, and recalculated at each action potential. Thus, after each spike, the threshold for the spike prediction was updated using the following equation:

\begin{equation}
\centering 
V_{threshold}=V[t_{spike}[i-1]-\tau],
\end{equation}

\noindent with $\tau$ being the selected time for the prediction before the spike and $t_{spike}$ the time instant of the spike peak.

This prediction is effective for stereotyped spikes when only low amplitude subthreshold oscillations occur, but it is limited in other scenarios. Therefore, for neurons or action modes of the same neuron when it was necessary to stimulate before the depolarization rise, another reference was used: the area of the recorded voltage. In this other mode of the protocol defined in Eq. \ref{eq:area}, the voltage was accumulated along the activity and the sum was reset after each spike. 

\begin{equation}
\centering 
V_{area}=\int_{V[spike_{i-1}]}^{V[spike_{i}]}V(t).
\label{eq:area}
\end{equation}

The stimulation was triggered when the area reached a specific threshold, which was predicted as in the voltage case, or hand-tuned. For the detection of the minimum point to reset the voltage area, we used a RTXI module based on RTHybrid, a real-time software that includes automatic adaptation algorithms to handle the ongoing variability of the recordings \parencite{amaducci_rthybrid_2019,reyes-sanchez_automatic_2020,reyes-sanchez_automatized_2023}, \href{https://github.com/GNB-UAM/rthybrid-for-rtxi/tree/master/rthybrid_burst_analysis}{github.com/GNB-UAM/RTHybrid-For-RTXI}. The use of each mode of the protocol in the experiment was decided depending on the specific requirements of the recorded activity. 

\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/offset_examples.pdf}
	\caption{Examples of illumination offset, defined as the time interval from the end of the illumination to the peak of the spike.}
	\label{fig:offset_example}
\end{figure}

Using this detection protocol, we assessed the effect of the illumination at different phases of the action potential in the range from 100 ms before the spike peak to 80 ms after the spike peak (see an example of the illumination offset in Fig. \ref{fig:offset_example}). The illumination interval was 58 ms, validated as the minimal duration for effective stimulation in the test trials. The RTXI module programmed for this study is available at \href{https://github.com/GNB-UAM/spike_predictor}{github.com/GNB-UAM/spike\_predictor}.

\subsection{Spike waveform characterization parameters} \label{sec:characterization parameters}
\label{sect:metrics}
For both experimental recordings and model simulations, action potentials were detected as the maximum point over a threshold, and each waveform was segmented 100ms before and after the peak temporal reference. For the superposition of action potentials (Figs. \ref{fig:continuous_results_panel},\ref{fig:continuous_model},\ref{fig:temperature model}) the waveforms were aligned in the $x$-axis by the peak and in the $y$-axis by the first point of the waveform voltage values.

\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/spike_metrics.pdf}
	\caption{Representation of waveform shape's metrics: a) Spike duration at half width. b) Spike amplitude between the maximum and minimum voltage values. c) Depolarization slope at half width. d) Repolarization slope at half width.}
	\label{fig:spike metrics}
\end{figure}


For the waveform shape characterization, we used four metrics: duration, amplitude, depolarization and repolarization slopes. They are depicted in Fig. \ref{fig:methods_general}B and defined as follows:
\begin{itemize}
	\item Duration: Time interval between the two points at half width of the action potential. 
	\item Amplitude: Difference between minimum and maximum voltage values in the waveform in the analyzed segment. 
	\item Depolarization slope: Slope in the depolarization phase (previous to the peak) measured 1 ms before and after the half width point reference.
	\item Repolarization slope: Slope in the repolarization phase (after the peak) measured 1 ms before and after the half width point reference.
\end{itemize}

These metrics were used for the quantitative analysis of the change in experimental recordings and model simulations. In Sec. \ref{sect:statistical_analysis} below we describe the quantification methodology for the waveform metric change as well as for the comparison between the experimental and model results.



\subsection{Statistical Analysis}
\label{sect:statistical_analysis}
The statistical significance analysis in the data obtained from the sustained CW-NIR stimulation protocol in Figure \ref{fig:continuous_results_panel} was performed applying a paired T-test to the four spike waveform metrics characterized here (see Fig. \ref{fig:methods_general}B). Data from distinct experiments was gathered and paired by recordings of control-laser and control-recovery (see Fig. \ref{fig:continuous_results_panel}C). The null-hypothesis tested was that control group was equal to the laser group and that the control group was equal to the recovery group, respectively. Since we performed the test in the four waveform metrics --spike duration, depolarization slope, repolarization slope and amplitude-- we applied the Bonferroni correction, thus we considered high-significance when $\rho < 0.01/4$.

To compare recordings from different neurons, we normalized the change between the laser and the control conditions for each waveform metric using the following expressions for electrophysiological data:

\begin{equation}
	{metric\ change}_{experimental} = \frac{|\mu(metric_{laser}) - \mu(metric_{control})|}{|\mu(metric_{control})|},
\end{equation}
\noindent where $\mu(metric_{laser/control})$ is the mean of the corresponding metric for all waveforms in a given laser stimulation or control trial.

Analogously, to compare the change between the distinct model simulations we normalized the change in the parameter-driven simulated variability range using the following expression:

\begin{equation}
	\label{eq: model change}
	{metric\ change}_{model} = \frac{|metric_{min} - metric_{max}|}{|metric_{max}|},
\end{equation}

\noindent where $metric_{min/max}$ refers to the minimum or maximum value of the corresponding waveform metric resulting from the model simulations in the  considered parameter range.


For the comparison between experimental data and model simulations in Figure \ref{fig:continuous_model}, we defined an experimental reference for each metric as the general mean and standard deviation for all experiments ($N=23$). This allowed us to define a range of change due to the laser effect to which the model values could be compared. The mean of metric experimental change (MEC) was defined as:
\begin{equation}
	\mu_{MEC} = \frac{1}{N}\sum_{i=1}^{N}\frac{|\mu(\text{metric})_{\text{laser}} - \mu(\text{metric})_{\text{control}}|_{i}}{|\mu(\text{metric})_{\text{control}}|_{i}},
\end{equation}

Here, $\mu(\text{metric})_{\text{laser}}$ and $\mu(\text{metric})_{\text{control}}$ represent the mean values for each experiment $i$ in laser stimulation and control trials, respectively, where the index $i$ ranges for all experiments, with $N$ being the number of experiments.

Thus, the percentage change in waveform from the model simulations, as described in equation \ref{eq: model change}, was mapped to this reference range: $(\mu_{MEC}\pm2\sigma_{MEC})$, with $\sigma_{MEC}$ being the standard deviation of the MEC. To visually represent this range, we utilized a color gradient with the \textit{background\_gradient} option in \textit{DataFrame} style in Python. The formula for mapping these values is:

\[\text{Gradient value} = \frac{\text{value} - \text{Vmin}}{\text{Vmax} - \text{Vmin}}\]

Here, \textit{value} represents the percentage change in the model simulation for a specific metric, while \textit{Vmin} and \textit{Vmax} represent $\mu_{MEC}-2\sigma_{MEC}$ and $\mu_{MEC}+2\sigma_{MEC}$ respectively, with $\mu_{MEC}$ and $\sigma_{MEC}$ being the specific mean and standard deviation corresponding to the metric specified in \textit{value}. Since all changes are in absolute value, the lower bound for Vmin is 0.

All data analyses were performed in Python, the scripts are available in \href{https://github.com/GNB-UAM/Garrido-Pena_Modulation-neural-dynamics-by-CW-NIR-stimulation}{github.com/GNB-UAM/Garrido-Pena\_Modulation-neural-dynamics-by-CW-NIR-stimulation}.


\section{Sustained CW-NIR laser stimulation effect on single neuron dynamics}
\subsection{CW-NIR laser effect on spike waveform}
In this paper we performed experimental triplets of control, sustained CW-NIR laser stimulation and recovery recordings (for details see Sec. \ref{sect:sustained-protocol}). This protocol provided a reference for the characterization of the laser effect. The data analyzed in this section corresponds to the spontaneous activity of neurons from the right parietal ganglion (RPG) of \textit{Lymnaea stagnalis}, under no stimulation other than the laser illumination when specified.

Left panels in Fig. \ref{fig:continuous_results_panel}A and B illustrate the stereotyped waveform of the action potential from two experiments in two distinct neuron types present in the RPG with symmetrical and shoulder spike shapes, respectively. Note that the two neuron types differ not only in spike waveform but also in duration. In the example shown in Fig. \ref{fig:continuous_results_panel}A, the duration of the spike was $\sim$20 ms whereas the one shown in Fig. \ref{fig:continuous_results_panel}B was $\sim$40-50 ms. To characterize the sustained CW-NIR laser stimulation in terms of change and recovery, the three stages of the protocol --control, laser and recovery-- are represented in all panels. The superimposition of the spike waveforms ($\sim$40 and 110 spikes for each trial, panels A and B, respectively) for the same recording are aligned in the $x$ axis by the spike peak and in the $y$ axis by the voltage amplitude of the first point of the waveform, together with the trial mean spike represented with a wider line. Note how the control and recovery traces overlap for both neuron types, illustrating the resumption of the spike dynamics shortly after the laser stimulation ceases (see aligned spikes in Fig. \ref{fig:continuous_results_panel} A and B).

Figures \ref{fig:continuous_results_panel}A and B illustrate that the variability was very small in amplitude, duration and in depolarization or repolarization slopes between the spikes within the same trial in both neuron types. However, during CW-NIR laser stimulation, the change in action potential waveform shape was notable with respect to the control and the recovery. This change was most clear in the spike duration, which was the result of changes in both depolarization and repolarization slopes. 

\begin{figure}[htb!]
	\centering
	\includegraphics[width=\textwidth]{img/laser/Figure2.pdf}
	\caption{Effect of sustained CW-NIR laser stimulation on the spike waveform for two distinct neuron types. For all panels: control, laser and recovery are color coded in blue, red and green, respectively. Panel A. Characterization of no shoulder shape type neuron. Panel B. Characterization of shoulder shape type neuron. Ai) and Bi) Superimposition of spike waveforms in a single trial recording corresponding to a symmetrical and shoulder spike neuron, respectively. The spikes were aligned to the peak for the $x$ axis and to the onset for the $y$ axis, the mean is depicted in darker colors. Aii) and Bii) barcharts quantify the change using the difference from laser to control normalized by the mean control value for metrics: duration, depolarization and repolarization slopes, and amplitude. Panel C, violin plots representing the variation of the experiments with respect to the control ($N=23$) for shoulder and symmetrical types together. For each metric of the waveform, the control, laser and recovery recordings are normalized to the first control. From left to right: duration, depolarization slope, repolarization slope and amplitude. Asterisks over the violins indicate that the metric change was highly significant (Bonferroni correction, ($\rho<0.01/4$), see Statistical Analysis Sec. \ref{sect:statistical_analysis} in Materials and Methods).}
	\label{fig:continuous_results_panel}
\end{figure}

The right panels ii) in Fig. \ref{fig:continuous_results_panel}A and B, show barcharts that quantify the change in terms of spike duration, amplitude, depolarization slope and repolarization slope. These metrics were used to characterize the action potential waveform and its possible change during the laser illumination (see also Fig. \ref{fig:methods_general}B and Sec. \ref{sect:metrics}). Each one of these metrics is represented on the right panels as the absolute value of the difference of the laser stimulation to the control recording normalized by the mean control value (see Sec. \ref{sect:statistical_analysis}). For both neuron types there was a change in duration and in the slopes, with the largest change being in the repolarization slope (around 26\% for the symmetrical spike type neuron and 86\% for the shoulder type). The alignment illustrated in the left panels shows that the change in amplitude was minimal in comparison to the rest of the metrics. Although both neuron types showed an effect of the sustained CW-NIR laser stimulation in the action potential waveform, the change in the shoulder neuron type was larger for duration and slopes. This may be due to specific channels that generate the shoulder shape of the spike, which may allow for a wider range of change in the spike dynamics, especially in terms of the repolarization slope. 


Panel C in Fig. \ref{fig:continuous_results_panel} displays the results of multiple experiments following the same protocol described above, represented in violin plots as the normalization of each experiment with respect to the mean of the first control of the respective metric for each spike detected during control, laser and recovery. To avoid possible bias from the natural evolution of the intracellular recordings, in this figure we only included experiments where the activity was recovered within 10\% change in firing rate with respect to the control. For each trial, only stereotyped waveforms were considered and large deviations (in the form of $z_{score} < -0.1$ in the normalized duration) were filtered out. The variability characterized in the control violins represents the variation within controls, which was also the most homogeneous in terms of density distribution. This is represented for each one of the selected spike waveform characterization metrics as in panels A and B --duration, depolarization slope, repolarization slope and spike amplitude (see Fig. \ref{fig:methods_general}B).

The results shown in Fig. \ref{fig:continuous_results_panel}, panel C are consistent with the described change in the illustrative individual experiments shown in panels A and B in the same figure. On the one hand, the activity recovered its initial characteristics after the CW-NIR laser stimulation ceased for every metric, i.e., the recovery (green violin) returned to the same level as the control (blue violin). The differences in these distributions are mainly caused by the natural variability in the biological system. Also, as all values are normalized to the mean of the first control, it can be expected that the distributions may diverge more in laser and recovery violins than in control violins. A separate analysis for the two neuron types is available in Fig. \ref{fig:continuous panel s1}

\begin{figure}
	\includegraphics[width=\textwidth]{img/laser/FigureS1.eps}
	\caption{Segregation of data into shoulder and symmetrical neural types. Violin plots for the four metrics -duration, depolarization slope, repolarization slope and amplitude- grouped by control, laser and recovery trials. Spikes metrics are normalized to the first control, as in Fig. \ref{fig:continous_results_panel} panel C}
	\label{fig:continous panel s1}
\end{figure}

Regarding the change during the laser stimulation, for every waveform metric except amplitude, we can see in Fig. \ref{fig:continuous_results_panel}C how the overlapping of the distributions is minimal. The distribution for the duration was the most homogeneous, whereas the variation for depolarization and repolarization slopes had different density distributions, being the repolarization slope the one presenting a larger change in most cases. This can be explained by the variety of neurons in the collected data, the change in the slopes differed from one type of neuron to another. Thus, the distribution of variability was different. Some laser stimulation recordings presented a milder change than others. The slight change along neurons of the same type was likely due to the physical restrictions of the setup in each experiment: the angle of the laser, the laser focusing, the maximum power used and the overlaying tissue. Overall, considering these factors, we can see that stimulating with the sustained CW-NIR laser resulted in a significant change of the spike waveform. In the case of the amplitude, the change was very small. 

We performed statistical tests on these data and confirmed that the changes in duration, depolarization and repolarization slopes were highly significant ($\rho < 0.01 /4$) when comparing control and laser samples. The amplitude change was not highly significant, and so were not the changes in any metric comparing control and recovery samples (see Statistical Analysis Sec. \ref{sect:statistical_analysis}).

This combination of changes points out to different biophysical candidates that might be involved in the modulation for the global change in both slopes or specific channels involved in the CW-NIR laser effect, since the deporalization and repolarization slopes were affected differently, while the amplitude did not change, and for distinct neuron types the characterized metrics had different variations (i.e., the repolarization slope in the shoulder shape neuron type was reduced to a greater extent than in the symmetrical type). In section \ref{sect:models} we assess these possible candidates using a computational model. 

\subsection{CW-NIR laser effect on spiking rate}
During the identification of the biophysical effect at different phases of the action potential dynamics on single neurons, we identified a robust acceleration of the action potential (a shorter duration of the spike waveform). This could also point to an acceleration of the tonic activity of the neurons. Pulsed NIR laser stimulation has been proven effective as a stimulation technique, mainly eliciting action potentials (APs) in silent neurons at specific combinations of pulse duration and intensity \parencite{wells_application_2005, shapiro_infrared_2012, izzo_optical_2007, cayce_infrared_2014}. Thus, we also assessed the effect during sustained CW-NIR infrared laser stimulation on the spiking frequency in long stimulation recordings (1-3 min). 

To avoid possible bias originated from intrinsic properties of the neuron and the circuit in which it was integrated, we only considered recordings where the neurons effectively recovered their control activity rate after the stimulation (i.e., absolute recovery change within 10\% from the initial control). The activity frequency was characterized by the absolute firing rate (AFR) for control, laser and recovery, and by a histogram of Inter Spike Intervals (ISIs), i.e., the time interval from peak to peak.

\begin{figure}[hb!]
	\centering
	\includegraphics[width=\textwidth]{img/laser/Figure3.pdf}
	\caption{Firing rate and interspike interval (ISIs) analysis for the CW-NIR laser stimulation. A. Absolute firing rate in all experiments (N=23). B. Absolute firing rate for cases from the experiments in A with no change during laser illumination (N=11); C. Absolute firing rate for experiments from A showing an increase in the firing rate (N=12); D. ISI histograms for control, laser and recovery for each experiment. Cases showing increased excitation in their firing rate (sample in panel C) when illuminated by the CW-NIR laser are highlighted in a red square.}
	\label{fig:frequency FR}
\end{figure}

In Fig. \ref{fig:frequency FR}, the mean firing rates for control, laser and recovery are represented along with their standard error of the mean. Panel A depicts the general change in frequency for the neurons, showing the neural activity trend to excitation in the mean. In panels B and C, this set of triplets is divided into two groups depending on the difference between the laser and the control, classified as no change when the difference between control and laser was less than 10\% (panel B), and as excitation for the opposite case (panel C). There is no representation of inhibition in this panel, since there was not any experiment that fulfilled the criteria of a 10\% negative change during the laser stimulation with respect to the control. Note how cases where the activity increases are the most consistent ones (12 out of 23) and that even in the set classified as unchanged, the mean of the AFR during laser stimulation is larger than the controls. These results support an excitatory tendency during CW-NIR sustained stimulation.

The absolute firing rate hinders some characteristics of the neural activity, such as the refractory period or the presence of bursting activity, which might also influence the firing frequency study. Thus, Fig. \ref{fig:frequency FR}D displays the ISI histogram for each experiment showing again the triplets of control, laser and recovery, for each sample. Experiments showing excitation are highlighted in a red square. Note that for most cases classified as excitation, the ISIs tendency is to be reduced, which is observed in the laser histogram at the left of the control and the recovery. Note that there are some experiments where the laser ISI histogram seems to overlap with the controls and the recovery (see Fig. \ref{fig:frequency FR}D, panels [2,A] [3,A] and [2,C]) but still the mean AFR of the laser recording was 10\% higher than the control. In these situations, even though the activity was faster under stimulation, the time between spikes did not show a proportional change, which can be due to a modulation in the refractory period that compensated the spike acceleration. Under the laser modulation, we also found that some neurons would start firing in shorter ISIs, tuning the tonic spiking into pair spiking similar to small bursts, e.g. Fig. \ref{fig:frequency FR}D, panel [2,F].

Overall, our results in this subsection show a larger tendency to a frequency increase in response to the NIR illumination indicating that it is possible to achieve neuronal excitation under sustained CW-NIR laser stimulation. It is also important to highlight that inhibition was not found in any of these experiments with sustained CW-NIR laser stimulation during tonic firing activity. 


\subsection{Effect of CW-NIR stimulation in a minimal circuit}


\subsection{Effect of CW-NIR stimulation at different wavelengths}
\section{Model analysis for constraining candidates to explain the effect of CW-NIR laser illumination in the spike dynamics}
\label{sect:models}

\subsection{Parameter range modification for the biophysical candidates in the model. }
Computational models are a powerful tool to assess the source of neural dynamics where all variables involved are accessible. By considering membrane potential recordings alone, it is difficult to understand the contribution of the biophysical candidates in the underlying dynamics shaping the action potential. While it is specially hard to carry out experiments using chemical and/or electrophysiological techniques to selectively block or compensate channels to mimic the observed CW-NIR laser effect, the simultaneous accessibility to all the variables in a model provides a unique tool to dissect the contribution of all biophysical candidates. Thus, to further explore the source of the experimentally observed CW-NIR effect, we analyzed the spike generation dynamics in three different conductance-based models assessing the change in the most likely candidates to be affected by the laser stimulation: modulation of membrane capacitance and ionic channels. More specifically, we modulated (i) the capacitance and the conductance of the active ionic channels --$I_{Na}$ and $I_{K}$-- in the standard Hodgkin-Huxley (HH) model \parencite{HODGKIN1952}; (ii) the conductance of ionic channels --$I_{NaP}$,~$I_{NaT}$,~$I_{D}$,~$I_{A}$,~$I_{HVA}$,~$I_{LVA}$-- and capacitance in a \textit{Lymnaea stagnalis} CGC neuron model with a shoulder shape waveform \parencite{vavoulis_balanced_2010}; and (iii) the capacitance in a two-compartment model --where the fast and slow dynamics are segregated-- in a \textit{Lymnaea stagnalis} buccal ganglion neuron (N3t) model \parencite{Vavoulis2007}. The implementation of these models is available in the open-source model library Neun \href{https://github.com/GNB-UAM/neun}{github.com/GNB-UAM/Neun} and the code for the simulations can be accessed in \href{https://github.com/GNB-UAM/Garrido-Pena_Modulation-neural-dynamics-by-CW-NIR-stimulation}{github.com/GNB-UAM/Garrido-Pena\_Modulation-neural-dynamics-by-CW-NIR-stimulation}.

The model parameters were modulated to investigate and compare their effect to that of the CW-NIR laser stimulation on the neurons, and to evaluate the interrelationship between the observed changes. To identify changes in the spike dynamics similar to those observed under the CW-NIR laser illumination, in this section we covered a complete range of values in the parameter space of each biophysical candidate. The criteria for driving the parameter exploration were the preservation of tonic spiking in the activity and the assessment of a realistic range of values.
As our initial hypothesis did not assume that the CW-NIR laser effects were exclusively photo-thermal, model parameter changes were applied with no temperature description. Further down in Sec. \ref{sect:temperature model} we present a detailed study considering the temperature dependency of the biophysical candidates. 

\begin{figure}[hbt!]
	\centering
	\includegraphics[width=0.8\textwidth]{img/laser/Figure4.pdf}
	
	\caption{Modeling study of the CW-NIR laser stimulation effects due to isolated biophysical changes that alter the spike waveform. Panels A, B, C and D: Superposition of spike waveforms in each model by modulating a single biophysical candidate. The background colors correspond to each simulated model. In Panel A, the capacitance is changed for the HH and CGC neuron models, and in the two compartments for the N3t neuron model. Panel B shows the spike waveforms changing the conductances of $Na$ channel currents: $I_{Na}$ from the HH-model, $I_{NaP}$ and $I_{NaT}$, from the CGC-model. Panel C, displays the modulation of $K$ conductances in ionic currents: $I_{K}$ in the HH-model and $I_{D}$ and $I_{A}$ for the CGC-model (from left to right). Panel D shows the modification of the calcium current conductances in the CGC-model ($I_{HVA}$ and $I_{LVA}$). Table in panel E represents the quantification of the changes in the spike metrics when tuning each parameter for every model. Each cell contains the waveform change normalized to the maximum. The color gradient represents similarity based on the standard deviation of the normalized experimental change. Dark purple corresponds to low similarity ($2\sigma_{\textrm{MEC}}$ or larger) and white to high similarity. The quantified experimental reference (MEC) is annotated in the first row of the table.}
	\label{fig:continuous_model}
\end{figure}

The results of this study are shown in Fig. \ref{fig:continuous_model}. The analysis for each model is sorted by the explored biophysical candidate --capacitance, sodium channels, potassium channels and calcium channels--. Thus, panels A, B, C and D show the superposition of all spike waveforms from the simulations for the range of explored model parameter values of each candidate. The table in Panel E represents how well the different model candidates reproduce the observed experimental effect. For each metric and biophysical candidate, there is a percentage of change in the model calculated as the change from minimum to maximum normalized with the maximum value (analogously to the quantification in Fig. \ref{fig:continuous_results_panel}, see also Sec. \ref{sect:statistical_analysis}). The background color in each cell represents the ability of each model parameter modulation to produce results similar to the change in the experimental results. The color gradient (represented in the color bar) takes as reference the mean of the metric experimental change (MEC) quantification, considering the range of $(\mu_{\textrm{MEC}}\pm2\sigma_{\textrm{MEC}})$ (see Sec. \ref{sect:statistical_analysis}). The mean change and its standard deviation were computed as the normalized difference between mean values for each control and laser experimental pair for all experiments. These reference values are shown for each metric in the first row of the table in panel \ref{fig:continuous_model}E to compare them with the model results. Thus, dark purple corresponds to values two times the STD of the mean over or under the mean, and white represents the mid point between those two values, i.e., high similarity to the experimental modulation. For example, in the case of Capacitance in the HH model, the change in duration was minimal 3.2\%, while the mean change in the experimental observation was 32\%, this color is then represented in dark purple, since 3.2\% is not in the defined range (32±20). On the other hand, the change in depolarization slope for this model (28.3\%) is depicted in light purple, since it is in the defined range and close to the mean metric experimental change (23±12).


\subsubsection{Change in Capacitance}
Capacitance has been one of the most discussed biophysical candidates to be affected by IR laser illumination \parencite{shapiro_infrared_2012, shapiro_correction_2017,cayce_infrared_2014, plaksin_thermal_2018}. A change in capacitance has a direct effect on the spiking frequency and exerts a global modulation on all ionic currents, so many studies have discussed this change both experimentally and theoretically.
Here we explored the CW-NIR modulation of capacitance in three different conductance-based models: in the Hodgkin-Huxley model, used in other studies, in the CGC-Vavoulis model, which presents a variety of channels and in the N3t-model, which is the only one with more than one compartment and, thus, has two distinct capacitance values. 

Figure \ref{fig:continuous_model}A displays the waveforms of each simulation. In the case of the HH-model, there was a mild change in duration, mainly caused by the depolarization modulation, and a change in amplitude larger than what was observed experimentally. The CGC-model exhibited a similar tendency to the HH-model but with an extreme case at a low value of capacitance $0.5 \mu F/cm^2$, where moderated changes in depolarization and amplitude were combined with a large change in the repolarization, and consequently in the duration. This modulation made capacitance a better candidate for reproducing the experimental results in the case of the CGC neuron, preserving the metrics' change interrelations, i.e., the combination of a minimal change in amplitude and a large change in duration, together with a larger change in repolarization than in depolarization slope. In the N3t neuron, we can see contrasting results for the two different compartments. In the compartment containing slow currents, the change in amplitude was the most striking, seemingly conditioned by both slopes. In the case of the fast current compartment the main change was observed in repolarization rather than depolarization, which is more similar to the experimental outcome. 

These results are quantified in the table in Fig. \ref{fig:continuous_model}E. The HH-model showed a change comparable to the experimental one only for the depolarization slope. The CGC-model reached plausible values in terms of the interrelation between metrics (large change in duration generated by a larger change in repolarization than in depolarization slope), but it exceeded the experimental references. The change in amplitude was larger than seen in the experimental results for most parameters (dark purple). It is especially clear in the case of the two-compartment model (N3t neuron), in which the modulation of capacity in the slow compartment resulted in a large change in amplitude. In contrast, the small change in amplitude in the fast compartment was the most similar value with respect to the experimental results (light purple).

By changing the capacitance, we achieved some of the expected changes, but achieving the desired results for all four metrics simultaneously was not possible. Therefore, modulating capacitance alone does not reproduce the experimentally observed effects, especially regarding the combined change, e.g., large change in repolarization and small change in amplitude, larger change in repolarization than in the depolarization. It was only when the fast compartment of N3t was modified that relations between these four metrics matched the above relationships. But note that changing the capacitance in the slow compartment is equivalent to changing several ionic currents simultaneously, not just a single current property. 

\subsubsection{Ionic channels}
The other mechanism to explain the laser modulation that we assessed here was a direct effect on the ionic channels involved in the generation of action potentials. These channels are activated in a sequential manner, and each of them is directly involved at distinct stages of the action potential generation. They have been discussed in the laser stimulation literature \parencite{liang_temperature-dependent_2009,li_temporal_2013, rabbitt_heat_2016} by a direct effect of maximal conductance, and channel opening and closing dynamics due to thermal effects, e.g., in calcium channels \parencite{albert_trpv4_2012, barrett_pulsed_2018}. These candidates were assessed here in the two single compartment models, the HH-model due to its wide use in computational neuroscience and the Vavoulis-CGC model for its variety of channels (including calcium currents) and accurate reproduction of the observed neural waveform shape. Note that in the CGC-model analysis, all currents types are in pairs of high and low conductance as well as fast and slow dynamics, having two currents for sodium, potassium and calcium (see Fig. \ref{fig:methods_general}D in Materials and Methods).

In Fig. \ref{fig:continuous_model}B the spikes from the simulations for each sodium current in the HH and CGC models --$I_{Na}$, and $I_{NaP}$ and $I_{NaT}$, respectively-- are superimposed. For the three currents, we observed modulation in both depolarization and repolarization slope, which resulted in a change in duration. Although the change in duration is close to the experimental outcome, the change in the depolarization is larger than in repolarization (see Fig. \ref{fig:continuous_model}E), which is contrary to the experimental results, as it is also the change in amplitude for $I_{Na}$, and $I_{NaP}$. However, for channel $I_{NaT}$ the change in amplitude was smaller, falling closer to the experimental range for amplitude and duration, but the change in depolarization exceeded the experimental range and the repolarization change was limited in the context of shoulder type neurons (the waveform type that reproduces CGC-model). Although the change of sodium channels alone generated a similar change in duration in relation to the experimental results, the rest of the metrics did not replicate those results.

Analogously, in Fig. \ref{fig:continuous_model}C, simulations for potassium currents ($I_K$ and $I_D$ and $I_A$, respectively) are represented for HH and CGC models. For the three currents, the major change was in the repolarization slope followed by the depolarization (see quantification in Fig. \ref{fig:continuous_model}E). This combination resulted in a modulation of the duration that lay in the range of similarity to the experimental results, with the exception of the amplitude, which does not correspond to the experimental results. It is especially applicable in the case of $I_K$ in HH-model and in the conductance of the strong potassium current $g_D$ of the CGC-model. Note that for the $I_A$ current, although the combination of changes were comparable to the experimental change, their range was not, so a change in this current alone was not considered a plausible candidate. Thus, a change in potassium channels reproduced the experimental results for duration and the two slopes overall, but it was limited due to 
an excessive change in amplitude.

In order to inspect the CGC-model in detail, we also simulated the changes in the calcium currents --$I_{HVA}$ and $I_{LVA}$-- for this model. These currents have a key role in the generation of the shoulder shape in the spike (Figure \ref{fig:continuous_model}D). Both created a similar change in the repolarization slopes, as well as in the depolarization, which is also close to the experimentally observed modulation. For duration, $I_{HVA}$ better matched the change, but this modulation was also accompanied by a large change in amplitude which was not observed in the experimental results. On the other hand, $I_{LVA}$ had one of the minimum effects on amplitude but, contrary to experimental results, its effect on the duration was also minimal, although the depolarization and repolarization slopes had a comparable change to the experimental observations. Therefore, altering each calcium channel effectively reproduced the desired change in the slopes but the modulation in duration and amplitude occurred in the same proportion, which does not match the experimental results.

The results described in this section indicate that each candidate can be modulated to bring the waveform closer to the experimentally observed results, but when changed separately they account only for a partial set of metrics matching. The desired combination of changes for duration, slopes and amplitude was not achieved by tuning only one parameter at a time. However, some of the candidates came close to this combination. Considering the ionic current candidates, the one that was closer to the \textit{in vivo} stimulation was potassium current, which reproduced a large range of change in the repolarization, depolarization and duration, though exceeding the change in the spike amplitude. This is relevant in terms of maintaining the observed interrelation of the metrics. Considering the range of change reached, the calcium channels where the best candidates for the reproduction of the experimental repolarization slope modulation, allowing a wide range of values and generating the shoulder shape waveform. We also saw how capacitance in single compartment models was not enough to reproduce the results. It was only when the capacitance was modified separately in two compartments, that the change reproduced the CW-NIR laser stimulation better. This points to a mechanism for explaining the CW-NIR laser effect with contribution from several candidates at the same time where specific factors might be of greater importance, such as the potassium channel in the case of shoulder shape neurons.

\subsection{Change of spike dynamics considering temperature modulation in the model}
\label{sect:temperature model}
Most studies in laser stimulation point out to a photo-thermal effect, e.g. see \parencite{wells_biophysical_2007, shapiro_infrared_2012, li_temporal_2013, rabbitt_heat_2016, ganguly_modeling_2016, cury_infrared_2021, pan_infrared_2023}. Thus, in this section we include a model analysis with temperature modulation. We selected the CGC-model from Ref. \parencite{vavoulis_balanced_2010} since it is the richest model in terms of variety of channels and ability to mimic the spike waveform of shoulder type neurons. To study global temperature dependence in the model we added a $Q_{10}$ coefficient, representing the temperature sensitivity in the model parameters. The value for this parameter is usually applied to different channel properties and kinetics in a range from 1 to 4 \parencite{schauf_temperature_1973,cosens_temperature-dependence_1976,tang_precise_2010,alonso_temperature_2020}. 
Thus, we choose as a common value for $Q_{10}$ 3, as an average general value used in the literature \parencite{hodgkin_effect_1949,heitler_effect_1998,shapiro_infrared_2012, li_temporal_2013, rabbitt_heat_2016,ganguly_thermal_2019-1} and also proposed as a universal value for $Q_{10}$ to characterize temperature dependency for biochemical processes \parencite{elias_universality_2014}. We estimated the temperature change under laser stimulation at maximum power following an open-pipette method, with a resulting temperature increase of 1-2ºC (see Sec. \ref{sec:temperature-estimation} and Fig. \ref{fig:methods_general}C). Note that our CW-NIR laser wavelength is at one of the lowest absorption bands of water, so the open-pipette method probably underestimates the change in temperature in the neuron, being the change in the temperature caused not only by water heating but also by heating the tissue. In addition, the reported temperature range of laser induced variation in the literature is wide, depending on the system, the estimation technique and whether it comes from a model or an \textit{in vivo} estimation \parencite{shapiro_infrared_2012, rabbitt_heat_2016, thompson_modeling_2012}. Therefore, in our simulations we explored a wider range than our experimental estimation, considering 5ºC as a reference and the quantification of the change up to 10ºC.

\begin{figure}[hbt!]
	\centering    
	\includegraphics[width=\textwidth]{img/laser/Figure5.pdf}
	\caption{Waveform change in the CGC-model due to $\Delta T$ temperature variation. Panel Ai) shows the spike waveform superposition for distinct $\Delta T$ values. Spikes are aligned to the initial value of each waveform. In panel Aii) the normalized change in the waveform is depicted for all metrics (duration, depolarization and repolarization slopes and amplitude). Panel B shows the change in response to temperature variation from 1 to 10ºC ($Q_{10}=3$) in the normalized metrics.}
	\label{fig:temperature model}
\end{figure}

Figure \ref{fig:temperature model} shows the change in the spike waveform caused by variations in temperature. The $Q_{10}$ factor was added to every dynamical equation in the model (i.e., conductances, activation gates and capacitance, see Sec. \ref{sec:model equations temperature}). In panel A, we show the changes in the waveform for $\Delta T=0-5^{\circ}C$, represented as superimposed waveforms in Ai), and its quantification in Aii) normalized to the maximum, which is analogous to the previous sections (see Figs. \ref{fig:continuous_model} and \ref{fig:continuous_results_panel}): $|max-min|/|max|$. Note how both the spike waveform shape and the quantification of the changes are similar to the experimental results. We can observe changes in duration, depolarization and repolarization slopes, with a very small change in amplitude.
The modulation obtained by combining these parameters was not achieved by tuning them separately. It is important to highlight that as the temperature increased (red lines), the spike got narrower by the corresponding alteration in slopes and duration, which supports the hypothesis that the observed effect in single neurons of \textit{Lymnaea stagnalis} might be, to a large extent, caused by temperature gradient. In panel \ref{fig:temperature model}B, there is a comparison of different temperature changes for the same $Q_{10}$ value in the model. Note that the relation of each parameter to the change in temperature is different, being the repolarization slope the one with the strongest relation, increasing much more rapidly than the duration or the repolarization slope. This points to a main role in the change from some of the channels, especially those that have more tolerance to change. This relation in the repolarization is similar to the comparison of the two neuron types analyzed in the experimental results (Figure \ref{fig:continuous_results_panel}A), where the main difference was present in the repolarization.



Analogously to the simulations in the previous sections, we characterized the variations in the waveforms for each individual candidate, varying the temperature only for one ionic-channel at a time, with a similar result as in Figure \ref{fig:continuous_model}, where no candidate alone could reproduce the effect [Fig. S2 in the Supplementary Material]. To further explore these candidates and relations, we repeated the model simulation with temperature variations up to 5ºC but canceling the temperature dependency in one channel at a time. Note that overriding the temperature dependence of some of the channels at a time is only possible in a theoretical environment like this, which allows us to expose the role of each channel in relation to the temperature modulation. The results are also reported in [Fig. S2 in the Supplementary Material] showing the waveform variations for temperature dependency for one channel at a time, and its suppression for one channel at a time, along with the quantification of the change as the percentage of change (see Methods and Materials \ref{sect:statistical_analysis}). 

Exploring the waveform change during temperature variation showed that the most similar change to the experimental laser modulation was reached in the models with the temperature dependency description in all parameters. We showed that, for most currents as the temperature increases, the experimentally observed modulation relations were maintained, changing in duration and repolarization slope, with a larger change in repolarization slope and a mild change in amplitude. This is also supported by excluding temperature dependency from isolated ion channels and proposing temperature dependency for one channel at a time [Fig. S2 in the Supplementary Material]. Furthermore, it is in agreement with the results of the modeling sweeping the parameter space for distinct candidates without a specific description of the temperature (see Sec. \ref{sect:models}), which showed that no modulation of an individual candidate but a combination of them can explain the experimental quantification.


To further explore the role of the temperature on each channel, we have performed analogous simulations excluding and including temperature dependency for one channel at a time. The result of this analysis is in Figure \ref{fig:temperature simulation include exclude}. \todo{ampliar con texto antiguo; separar en 2?}


\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/FigureS2.pdf}
	\caption{Simulation of the effect of individual channels on the spike waveform under temperature modulation.} Panel A.i) Waveform modulation in the CGC-model excluding temperature dependency in one channel at a time, from left to right: $I_{\textrm{NaT}}$, $I_{A}$, $I_{\textrm{HVA}}$, $I_{\textrm{LVA}}$, $I_{D}$ respectively. Panel A.ii) Waveform modulation in the CGC-model with temperature dependency only in one channel at a time, from left to right: $I_{\textrm{NaT}}$, $I_{A}$, $I_{\textrm{HVA}}$, $I_{\textrm{LVA}}$ and $I_{\textrm{NaP}}$, respectively. Note that  $I_{\textrm{NaP}}$ is not in panel A.i) and neither is $I_{D}$ in A.ii), as for these two particular simulations there was no spike generation. Panels B.i) and B.ii) show the quantification of the waveform change for $\Delta T=5^{\circ}C$ in duration, depolarization slope, repolarization slope and amplitude for all channels in panel A. Both figures include, as reference, the experimental mean and STD (showed in black) and, for case B.ii) (only one channel at a time),  the quantification when all channels have the same temperature dependency (all with $\Delta T=5^{\circ}C / 3^{\circ}C$, data used in Figure 5) is depicted in light and dark red bars. Note that no candidate alone could reproduce the observed experimental laser modulation but some channels have a more direct relation to the temperature change such as  $I_{\textrm{LVA}}$ for the repolarization or $I_{D}$ channel, crucial for the spike generation waveform.
	\label{fig:temperature simulation include exclude}

\end{figure}

\section{Activity-dependent stimulation to assess the laser effect at distinct stages of the spike dynamics} 
\label{sec:activity dependent}
So far we have shown how sustained CW-NIR laser affects neural activity by modifying the dynamics of spike generation. In the previous section \ref{sect:models} we used a conductance-based model to theoretically assess the spike evolution and the different candidates involved in the modulation of the action potential generation (i.e., ionic channels and capacitance). To address this effect in an experimental setting is a complex task. Usually, it is accomplished using chemicals to block or open specific channels \parencite{liang_temperature-dependent_2009}. This is not a generalizable method in different systems and individuals, and it restricts the channel study to a system with a detailed description of the specific neuron being recorded. We chose instead to assess the spike generation dynamics at different stages, which implies modifying the activity of several channels at a time in a precise timing relative to the spike generation dynamics. This task is only experimentally feasible with an activity-dependent stimulation protocol.
\begin{figure}[htb!]
	\centering
	\includegraphics[width=0.8\textwidth]{img/laser/Figure6.pdf}
	\caption{Study of the laser effect at different stages of the spike waveform with an activity-dependent stimulation protocol. The panels quantify the change induced by the laser stimulation at distinct illumination offsets, --time intervals from the end of the illumination to the peak of the spike--. Top panel shows a spike waveform from the experiment as a time reference for the offset --time 0 corresponds to the spike peak. Boxplots represent the difference of each metric with respect to the control. All illumination intervals, pictured in the blue boxes, had the same duration of 58 ms and spikes were grouped by the illumination offset. Recovery and continuous laser reference are also shown in green and red boxes at left and right in the figure, respectively. The spike metrics selected here were duration, depolarization and repolarization slopes, --second, third and fourth rows, respectively.}
	\label{fig:activity dependent}
\end{figure}

In infrared stimulation literature, the most spread technique has been pulsed illumination which stimulates at a fixed frequency. Although this approach has been effective in some tasks such as eliciting neural activity, it has limited possibilities in the context of precision and adaptability. Thus, with the activity-dependent protocol proposed here, we also provide an open-access alternative to the widely-used fixed-frequency pulsed laser stimulation protocols, which usually depend on a specific combination of restrictions from manufacturers, controllers, and diode laser availability. In addition, a closed-loop approach provides further means to deal with the history-dependent nature of neural dynamics and its partial observability \parencite{varona_online_2016}. 


Here we propose a closed-loop stimulation protocol where we can differentiate between the phases of the action potential and illuminate the neurons only at certain intervals of the spike generation dynamics. In this protocol, the laser illumination was controlled by a mechanical shutter triggered by the prediction of events in the voltage signal. A real-time software system ran the prediction algorithm and triggered the illumination for short periods of time at different phases of the spike generation when distinct channels were active (see Sec. \ref{sect:methods-activity-dependent} and Fig. \ref{fig:methods_general}E). The prediction of the events was computed by two algorithms, one based on a voltage threshold updated at each spike peak occurrence and a second one that calculated the voltage area from the hyperpolarization (minimum) to the next hyperpolarization. Based on this prediction the illumination was triggered at the specified time before the spike occurrence (see Sec. \ref{sect:methods-activity-dependent} for details in these algorithms). The implementation of these algorithms is available as a module for the real-time open-source system RTXI \parencite{patel_hard_2017} in \href{github.com/GNB-UAM/spike_predictor}{https://github.com/GNB-UAM/spike\_predictor}.

Figure \ref{fig:activity dependent} shows the outcome of the application of this closed-loop protocol, with a stimulation interval lasting 58 ms. The time line in the figure represents the offset of the illumination, i.e., the time that corresponds to the end of an illumination interval to the peak of the action potential (see an illustration exemplifying the illumination offset in Fig. \ref{fig:methods_general}F). The offsets were in the range from 60 ms before the action potential peak up to 80 ms after its occurrence (this wide range is required because of the natural slow dynamics of \textit{Lymnaea stagnalis}'s neurons). Each row in the figure represents the change in relation to the mean of the respective control trials for every illumination range. The change is represented for the three metrics in which we observed modulation during sustained illumination --duration, repolarization and depolarization slopes, respectively--. The different stimulation intervals are grouped by the time offset from the illumination to the peak of the action potential. The spike shown in the figure is plotted as a reference of the phase of the action potential in which the illumination finished. Recovery and sustained laser references are also represented at the left and right of each row, in green and red, respectively. For the three metrics here displayed, we can see how as the illumination offset got closer to the spike, the change was larger, and then recovered as the illumination interval covered less the action potential, resulting in an arch shape trend. Although this trend is visible for the three parameters characterized, it is manifested to a different degree in each of them. Note also that there was a temporal shift of the laser effect depending on the instant of stimulation. The maximum change value and the initialization of the recovery was different for the depolarization and for the repolarization. The effect on each of these metrics directly depended on the spike phase when the laser was illuminating the neuron. Thus, this variation of the laser effect points to a distinct modulation on each channel. The magnitude of the change under the sustained laser stimulation was larger than that observed at any of the phases addressed with the activity-dependent protocol. This may be caused by a heating delay during the stimulation, although there was no difference between the first and last spike in the sustained laser, the opening time of the laser shutter might have been smaller than the heating time necessary for the neuron to reach the maximum effect.

\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/Figure7.pdf}
	\caption{Normalized change for grouped values of spike duration, depolarization and repolarization slopes at distinct illumination offsets in the activity-dependent stimulation protocol. Each value in each group was normalized to the mean of its corresponding day controls as minimum value and the mean of the continuous laser recordings for each day as the maximum value. The maximum value for each metric is marked by a black circle. }
	\label{fig:activity dependent error mean }
\end{figure}

Figure \ref{fig:activity dependent error mean } agglutinates the results from 5 different closed-loop experiments, all of them normalized to the mean of the control and sustained laser references for each day, as minimum and maximum values, respectively. The arch trend is maintained. Again, note that the maximum effect for each spike metric occurs at a different stage. For the depolarization, the maximum change was found at the range of -20 to 0 ms, which corresponds to a stimulation during the whole depolarization. A fast rise when the illumination ceased right after the spike can be seen (i.e (0-20] range), since it corresponded to a stimulation during the depolarization and repolarization. In the repolarization, this trend was slightly delayed, reaching the maximum difference from the control at (20-40]. Such changes were also reproduced in the duration. This points to a modulatory effect of the laser depending on the stimulation instant. Previous to -20 ms, the laser was illuminating the neuron while all ionic channels were starting to activate, specially those involved in the process of the depolarization. However, those channels involved in the repolarization and hyperpolarization were also active earlier than the peak. This is why we can see a difference in all three metrics even at the early ranges of the action potential generation (e.g. -80 ms).

Using the activity-dependent protocol we were able to assess the neural activity at different stages of its dynamics in a controlled way. The results from these experiments showed that it is possible to modify the action potential generation in a temporally precise manner and that the effect of the CW-NIR laser illumination is dependent on the instant of the stimulation. This sets the basis for assessing the biophysical sources of the effect impacting distinct channels without modifying the system condition. Also, it is a proof of concept demonstrating the possibility of developing laser stimulation protocols driven by specific neural activity events in an accessible and freely available real-time tool.

\subsection{Model simulation of activity-dependent stimulation}

To address in a computational approach the observed effect experimentally, we have simulated the effect on a CGC-model neuron modulating two of the channels where the effect on the neurons was larger. This way, only during a certain time interval, the conductance in channels gD and gHVA was modified to the value replicating hte "maximum effect" (see Figure \ref{fig:activity dependent model stimulation})

\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/activity-dependent-model/depol_model.png}
	\includegraphics[width=\textwidth]{img/laser/activity-dependent-model/repol_model.png}
	\caption{Simulation of the effect of CW-NIR laser in the CGC-model. Stimulating only during the depolarization or only during repolarization phases for first and second rows respectively.}
	\label{fig:activity dependent model stimulation}
\end{figure}

With this simulation we obtain the results in Figure \ref{fig:activity dependent simulation results}, where, as in the experimental results, the effect is larger when the stimulation is only in the repolarization slope, whereas while the effect is over the depolarization slope, the effect is only visibile in the depolarization slope. 

\begin{figure}[htb!]
	\includegraphics[width=\textwidth]{img/laser/activity-dependent-model/depol_combined.png}
	\caption{Results in the spike waveform for the simulation of the effect of CW-NIR laser in the CGC-model. Stimulating only during the depolarization or only during repolarization phases for first and second rows respectively.}
	\label{fig:activity dependent simulation results}
\end{figure}


\section{Discussion}
\subsection{Singularity of the sustained and activity-dependent CW-NIR stimulation on neural dynamics}
Advantages of infrared laser neuromodulation beyond its non-invasive nature include its relative simplicity regarding stimulation protocol design, good penetration depth and the possibility to implement highly selective spatio-temporal stimulation delivery. The effectiveness of future applications will depend on a clear understanding of the mechanisms of the neural dynamics modulation.

Most previous studies used protocols involving high-frequency pulsed lasers under the assumption that continuous-wave laser stimulation paradigms do not provide significant activation or neuromodulation \parencite{wells_application_2005, wells_application_2005-1, cayce_infrared_2014, chernov_infrared_2014, goyal_acute_2012, pan_infrared_2023}. Their focus involved heating the neurons to elicit spiking activity. The laser wavelengths used were mostly in the range of 1800nm, close to a water absorption band. Here we explored a different approach, using a 830nm CW-NIR laser in sustained and activity-dependent triggered stimulation instead of pulsed illumination at fixed frequency. This setup has a promising future for clinical applications for long-term stimulation and patient-based treatments.

We assessed the action of sustained and activity-dependent CW-NIR stimulation to unveil the biophysical sources of the observed modulation on neuronal dynamics. We combined experimental and theoretical methods to analyze this effect. First, we quantified the change on action potential waveform dynamics and on the inter-spike intervals by comparing triplets of long intracellular recordings of control, laser stimulation and recovery. We found that sustained exposure to 830nm CW laser effectively modulated the spike waveform in a reversible manner. We showed this modulation in two different neuron types, illustrating the generalization of the effect. We observed a stronger effect on duration and repolarization, followed by a less strong change in the depolarization slope and a minimal change on amplitude. The neuron dynamics was restored after stimulation. It is important to highlight that here we presented modulation of tonic spontaneous activity, not elicitation of spiking activity as in most previous studies \parencite{wells_application_2005,izzo_optical_2007,shapiro_infrared_2012,rabbitt_heat_2016}. We also showed a tendency to increase the spiking activity under sustained stimulation, not limited to a specific time/intensity configuration of laser pulses as it is most frequently done in the literature \parencite{izzo_optical_2007,goyal_acute_2012,beier_plasma_2014,pan_infrared_2023}. Although there are previous studies discussing the inhibitory ability of infrared-laser illumination \parencite{duke_transient_2013,lothet_selective_2017,ganguly_thermal_2019, begeng_activity_2022}, we did not find evidence of any direct CW-NIR inhibitory effect. Note that the origin of tonic spiking was affected by the intrinsic properties of the cell and the synaptic inputs within the circuit, e.g., the illuminated neuron might be triggering an inhibitory or excitatory feedback from other neurons, complicating the analysis. This explains the lack of excitation in a subpopulation in Fig. \ref{fig:frequency FR}. Spontaneous neural activity and the nature of the living preparation used may naturally tend to decrease the firing rate.

\subsection{Biophysical explanation of the CW-NIR modulation through modeling and activity-dependent stimulation}
The results of sustained CW-NIR illumination alone cannot discard previously suggested mechanisms such as cytochrome oxidase \parencite{wang_impact_2017,saucedo_transcranial_2021} or calcium release from internal storage \parencite{lumbreras_pulsed_2014}. The fact that the illumination directly affects the spike waveform but not always translates into an increased firing rate may indicate that there is more than a single mechanism involved. Moreover, our analysis of sustained laser stimulation does not point to a slow change such as the one expected with the liberation of Ca$^{2+}$ caused by a mitochondrial modulation \parencite{dittami_intracellular_2011,lumbreras_pulsed_2014}, since we observed a minimal delay between the illumination onset and the modulatory effect, and the illumination cessation and the recovery. The short exposure in the activity-dependent experiment with quick response time also points to a short timescale effect, such as a direct effect on the ionic channels.

Conductance-based models allowed us to identify the most compatible biophysical explanation to the CW-NIR modulation. We evaluated the capacitance and distinct ionic channels in the parameter space of three conductance-based models, which would be highly costly experimentally. We concluded that all candidates explored contributed to partial reproduction of the waveform modulation but none was sufficient to explain the full observed effect. Capacitance is one of the most discussed candidates \parencite{shapiro_infrared_2012,cayce_infrared_2014,thompson_infrared_2015,plaksin_thermal_2018}. However, in our modeling study, capacitance alone was not able to reproduce the modulation. Although the isolated modification of any channel resulted in a limited explanation of the CW-NIR change, late activation channels such as potassium --preserving the depolarization-repolarization change relation-- or high-activated calcium --necessary for shoulder shape modulation-- seem to play a key role reproducing the observed effect.

Temperature-dependent simulations validated that the best explanation for the sustained laser action is a combined modulation of channels, reproducing the observed change for amplitude, duration and slopes. This supports previous studies' hypothesis that the photo-thermal interaction is key in the NIR laser effect \parencite{wells_application_2005,li_temporal_2013,albert_trpv4_2012,rabbitt_heat_2016, barrett_pulsed_2018,brown_thermal_2020,cury_infrared_2021}. We selectively excluded one channel from the temperature dependency at a time in the CGC-model, which cannot be performed experimentally. We found $I_D$ and $I_{NaP}$ channels to be critical for the activity modulation, radically changing the waveform when altering temperature dependency. Also, canceling the temperature dependency of $I_{HVA}$ largely changed the amplitude, indicating its importance in preserving the observed amplitude-repolarization relation during the modulation.

Finally, a closed-loop protocol allowed altering the action potential at distinct generation phases. We presented a new open-source protocol for spike prediction to stimulate at precise times around the occurrence of the action potentials. The outcome of the CW-NIR effect at distinct time intervals in relation to the timing of the spike's peak highlighted the importance of the stimulus delivery time. By changing the illumination instant, we shifted the effect on the waveform shape, getting different maximum metric changes at different stages of the action potential generation.

These changes in the waveform open a discussion about the biophysical source of this effect. With short closed-loop illumination intervals ($<60ms$), we observed a controlled modulation of neural activity smaller than the effect during the sustained laser illumination. In the open-pipette estimation, the maximum change for the steady state temperature value (1-2ºC) was reached after 1s and the change after 50ms was only of 0.1ºC. This estimation was performed on the preparation's solution, and our laser wavelength is far from the intense water absorption bands. So temperature change could be higher in the neuronal membrane, as the specific heat capacity of the water is $\sim30\%$ larger than the estimated on the membrane \parencite{thompson_modeling_2012}. This would result in a faster temperature increase under heat-inducing stimulation. Also, in the model, we observed a change similar to the experimental results with $\Delta T>=5^{\circ}C$. Thus, the modulation might not be caused by simply heating the surrounding water. In the sustained stimulation, there might be additional modulation sources such as an effect on the mitochondria as it has been discussed in previous studies \parencite{dittami_intracellular_2011, lumbreras_pulsed_2014, saucedo_transcranial_2021}, which we cannot discard as adding to the modulation of ionic channels. However, the effect observed during the activity-dependent stimulation is unlikely to have other than fast sources such as ionic-channels. 
A rigorous characterization of the timescale of the temperature changes induced by the CW-NIR and the associated instantaneous voltage dynamics could provide further insight on the fast and slow biophysical mechanisms underlying the waveform modulation. This is particularly relevant for the design of fast activity-dependent protocols to produce the observed effect safely with minimal biophysical perturbation. An accurate characterization of the relation between temperature and neuronal dynamics under CW-NIR stimulation requires novel highly precise protocols to measure the membrane temperature and fast non-periodic electro-optical shutters controlled by real-time software technology.

\subsection{Applications for research and clinical use}
The open-source approach described in this paper can be generalized for any animal and preparation. In addition, our protocol leaves plenty of possibilities for other closed-loop stimulation methodologies, including clinical interventions. We provided an open-access repository with the code to reuse our protocols and the module for RTXI, which can be used with any control hardware including fast electro-optical shutters. 


Regarding the non-invasive nature of the CW-NIR laser effect, we could not observe any damage to the cells linked to the stimulation in our experiments. We can hypothesize that stimulation from a laser with higher power could be tolerated by neurons. The recovery of the neural dynamics after illumination does not mean that the CW-NIR laser stimulation cannot be employed to address laser-driven plasticity in protocols designed for this goal. We have shown that sustained CW-NIR laser effectively accelerates neural dynamics in single neurons affecting a combination of biophysical mechanisms. Also, our results indicate that novel research and clinical applications of the excitability increase of laser stimulation must rely on a careful selection of the stimulus parameters and the timing of the illumination. In this context, the results of our pioneer activity-dependent infrared laser stimulation provide a novel approach to adapt the modulation of neural dynamics to specific applications, particularly in the field of personalized treatments including stimulation-driven plasticity.


